<!DOCTYPE html>
<html>
<head>
<title>Attendance Dashboard</title>

<style>
body{
    font-family:Arial;
    background:#f9f9f9;
    padding:30px;
}

h2{ color:#0056b3; }

button{
    padding:12px 25px;
    font-size:16px;
    margin:10px 0;
    background:#28a745;
    color:white;
    border:none;
    border-radius:5px;
    cursor:pointer;
}

button:disabled{
    background:#aaa;
    cursor:not-allowed;
}

#status{
    margin-top:20px;
    font-weight:bold;
}
</style>
</head>

<body>

<h2>Welcome</h2>
<p id="user"></p>

<h3>Attendance</h3>

<button id="inBtn" onclick="markIn()">âœ… I am in Office</button><br>

<button id="outBtn" onclick="markOut()">ðŸšª I am Leaving</button>

<p id="status"></p>

<button onclick="logout()">Logout</button>

<script>

// Google Form URL
const FORM_URL =
"https://docs.google.com/forms/d/e/1FAIpQLSf6vzUcheslghKL4nR-a7_GgN3VESLjazzfsaxnmTuEaIY0ow/formResponse";


// Entry IDs
const ENTRY = {
    id: "entry.1859002656",
    name: "entry.339531515",

    date: "entry.1163502489",

    intime: "entry.542167419",
    outtime: "entry.1532127027",

    lat: "entry.1008700991",
    long: "entry.698099376",

    status: "entry.1126631987"
};


// Login Info
const id = localStorage.getItem("userid");
const name = localStorage.getItem("name");

if(!id){
    window.location.href="index.html";
}

document.getElementById("user").innerText =
"ID: " + id + " | Name: " + name;


// Time Control
const hour = new Date().getHours();

const inBtn = document.getElementById("inBtn");
const outBtn = document.getElementById("outBtn");


if(hour < 11){
    outBtn.disabled = true;
}
else if(hour >= 14){
    inBtn.disabled = true;
}
else{
    inBtn.disabled = true;
    outBtn.disabled = true;
}



// Get Date Parts
function getDateParts(){

    const d = new Date();

    return {
        year: d.getFullYear(),
        month: d.getMonth()+1,
        day: d.getDate()
    };
}


// Get Time Parts
function getTimeParts(){

    const d = new Date();

    return {
        hour: d.getHours(),
        minute: d.getMinutes()
    };
}


// Get Location
function getLocation(cb){

    if(!navigator.geolocation){
        cb("","");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos=>{
            cb(pos.coords.latitude,pos.coords.longitude);
        },
        ()=>{
            cb("","");
        }
    );
}



// IN
function markIn(){

    const t = getTimeParts();
    const d = getDateParts();

    let status = "Present";

    if(t.hour > 9){
        status = "Late";
    }

    sendData(d,t,null,status);

}



// OUT
function markOut(){

    const t = getTimeParts();
    const d = getDateParts();

    sendData(d,null,t,"Present");

}



// FIXED Send Data function
function sendData(date, inTime, outTime, status){

    getLocation((lat,long)=>{

        const fd = new FormData();

        // 1. Correct Date Format: Google Forms needs YYYY-MM-DD
        const dateStr = `${date.year}-${String(date.month).padStart(2,"0")}-${String(date.day).padStart(2,"0")}`;

        // 2. Add basic info
        fd.append("entry.1859002656", id);
        fd.append("entry.339531515", name);
        fd.append("entry.1126631987", status);
        fd.append("entry.1163502489", dateStr);

        // 3. Only add time if it exists (avoids sending empty strings that cause errors)
        if(inTime){
            const inStr = `${String(inTime.hour).padStart(2,"0")}:${String(inTime.minute).padStart(2,"0")}`;
            fd.append("entry.542167419", inStr);
        }

        if(outTime){
            const outStr = `${String(outTime.hour).padStart(2,"0")}:${String(outTime.minute).padStart(2,"0")}`;
            fd.append("entry.1532127027", outStr);
        }

        // 4. Add Location
        fd.append("entry.1008700991", lat);
        fd.append("entry.698099376", long);

        fetch(FORM_URL,{
            method:"POST",
            mode:"no-cors",
            body:fd
        })
        .then(()=>{
            document.getElementById("status").innerText = "âœ… Attendance Submitted";
            inBtn.disabled = true;
            outBtn.disabled = true;
        })
        .catch((error)=>{
            console.error("Error:", error);
            alert("Submission Failed. Check your internet or Form IDs.");
        });
    });
}



// Logout
function logout(){
    localStorage.clear();
    window.location.href="index.html";
}

</script>

</body>
</html>


