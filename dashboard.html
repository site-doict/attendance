<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Staff Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>

body{
    font-family: Arial, sans-serif;
    background:#f9f9f9;
    padding:20px;
    text-align:center;
}

#clock{
    font-size:28px;
    font-weight:bold;
    margin:15px 0;
}

button{
    padding:15px 25px;
    font-size:18px;
    margin:10px;
    cursor:pointer;
    border:none;
    border-radius:8px;
}

#inBtn{
    background:#28a745;
    color:white;
    display:none;
}

#outBtn{
    background:#dc3545;
    color:white;
    display:none;
}

.logout-btn{
    background:#6c757d;
    color:white;
}

#historyArea{
    margin-top:20px;
    background:white;
    padding:15px;
    border-radius:10px;
    max-width:600px;
    margin:auto;
    box-shadow:0 2px 5px rgba(0,0,0,.1);
    text-align:left;
}

.history-item{
    border-bottom:1px solid #eee;
    padding:6px 0;
}

#status{
    margin-top:10px;
    font-weight:bold;
}

</style>
</head>

<body>

<h2>Welcome</h2>

<p id="user"></p>

<div id="clock">00:00:00</div>

<h3>Attendance</h3>

<button id="inBtn" onclick="markIn()">‚úÖ I am in Office</button>

<button id="outBtn" onclick="markOut()">üö™ I am Leaving</button>

<div id="status"></div>


<div id="historyArea">

<h4>üìÖ Last 7 Days History</h4>

<div id="historyList"></div>

</div>

<button class="logout-btn" onclick="logout()">Logout</button>


<script>

// ================= CONFIG =================

const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbyBFqDyMNpKtbD3w4RNAjZ13BKkhl8pvFUEhrHsC-PzBvL-SV274jKCkClsY6pkKjMo/exec";


// ================= USER =================

const id   = localStorage.getItem("userid");
const name = localStorage.getItem("name");

if(!id){
    location.href="index.html";
}

document.getElementById("user").innerText =
`ID: ${id} | Name: ${name}`;


//
// ================= ELEMENTS =================
//

const inBtn    = document.getElementById("inBtn");
const outBtn   = document.getElementById("outBtn");
const statusTx = document.getElementById("status");


//
// ================= CLOCK =================
//

function updateClock(){

    const now = new Date();

    document.getElementById("clock")
    .innerText = now.toLocaleTimeString();
}

setInterval(updateClock,1000);

updateClock();


//
// ================= LOAD HISTORY =================
//

function loadHistory(){

    fetch(WEB_APP_URL + "?id=" + id)

    .then(r => r.json())

    .then(rows => {

        console.log("Fetched rows:", rows); // DEBUG

        displayHistory(rows);

    })

    .catch(err => {

        console.log(err);

        statusTx.innerText = "‚ùå Load Failed";
    });
}



//
// ================= BUTTON CONTROL =================
//

function controlButtons(rows){

    const now = new Date();

    const mins = now.getHours()*60 + now.getMinutes();


    // TIME RULES (minutes)

    const IN_START   = 8*60;        // 08:00
    const IN_CLOSE   = 10*60+30;    // 10:30

    const OUT_START  = 15*60;       // 15:00
    const OUT_CLOSE  = 18*60;       // 18:00


    // Hide first

    inBtn.style.display  = "none";
    outBtn.style.display = "none";


    // Today string - CHANGED FORMAT to match sheet (d/M/yyyy)

    const today = new Date();

    const todayStr =
    `${today.getDate()}/${today.getMonth()+1}/${today.getFullYear()}`;

    console.log("Today string:", todayStr); // DEBUG


    // Find today's record

    const rec = rows.find(r =>
        String(r.id).trim() === id &&
        String(r.date).trim() === todayStr
    );

    console.log("Today's record:", rec); // DEBUG


    // ---------- IN BUTTON ----------

    if(!rec || !rec.inTime){

        if(mins >= IN_START && mins <= IN_CLOSE){

            inBtn.style.display = "inline-block";
        }
    }


    // ---------- OUT BUTTON ----------

    if(rec && rec.inTime && !rec.outTime){

        if(mins >= OUT_START && mins <= OUT_CLOSE){

            outBtn.style.display = "inline-block";
        }
    }

}



//
// ================= DISPLAY HISTORY =================
//

function displayHistory(rows){

    const list = document.getElementById("historyList");

    list.innerHTML = "";


    const today = new Date();


    for(let i=0;i<7;i++){

        let d = new Date();

        d.setDate(today.getDate()-i);

        // CHANGED FORMAT to match sheet (d/M/yyyy)
        let dayStr =
        `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;

        console.log(`Day ${i} string:`, dayStr); // DEBUG


        // Find record

        let rec = rows.find(r =>
            String(r.id).trim() === id &&
            String(r.date).trim() === dayStr
        );

        console.log(`Day ${i} record:`, rec); // DEBUG


        let html = rec

        ? `‚úÖ In: ${rec.inTime||'---'} | Out: ${rec.outTime||'---'} | Status: ${rec.status||'---'}`

        : "‚ùå No Record";


        const div = document.createElement("div");

        div.className = "history-item";

        div.innerHTML =
        `<strong>${i===0?"Today":dayStr}:</strong> ${html}`;

        list.appendChild(div);
    }


    controlButtons(rows);
}



//
// ================= SEND DATA =================
//

function sendData(status,type){

    const now = new Date();

    const fd = new FormData();

    fd.append("id",id);
    fd.append("name",name);
    fd.append("status",status);
    fd.append("type",type);


    fetch(WEB_APP_URL,{

        method:"POST",

        body:fd
    })

    .then(r => r.json())

    .then(d => {

        if(d.success){

            let hours = now.getHours();
            let minutes = String(now.getMinutes()).padStart(2,"0");
            let ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
            
            const t = `${hours}:${minutes} ${ampm}`;

            statusTx.innerText =
            type==="in"
            ? `‚úÖ Marked IN at ${t}`
            : `‚úÖ Marked OUT at ${t}`;

            loadHistory();
        }

    })

    .catch(()=>{

        statusTx.innerText = "‚ùå Submit Failed";
    });

}



//
// ================= BUTTON ACTION =================
//

function markIn(){

    const now = new Date();

    let mins = now.getHours()*60 + now.getMinutes();

    let status =
      mins >= (10*60)
      ? "Late"
      : "Present";

    sendData(status,"in");
}



function markOut(){

    const now = new Date();

    let mins = now.getHours()*60 + now.getMinutes();

    let status =
      mins < (16*60+40)
      ? "Early Leave"
      : "Present";

    sendData(status,"out");
}



//
// ================= LOGOUT =================
//

function logout(){

    localStorage.clear();

    location.href="index.html";
}



//
// ================= START =================
//

loadHistory();


</script>

</body>
</html>
