<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staff Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    background:#f9f9f9;
    padding:20px;
    text-align:center;
}
#clock{
    font-size:28px;
    font-weight:bold;
    margin:15px 0;
}
button{
    padding:15px 25px;
    font-size:18px;
    margin:10px;
    cursor:pointer;
    border:none;
    border-radius:8px;
}
#inBtn{ background:#28a745; color:white; }
#outBtn{ background:#dc3545; color:white; }
.logout-btn{ background:#6c757d; color:white; }
#historyArea{
    margin-top:20px;
    background:white;
    padding:15px;
    border-radius:10px;
    max-width:600px;
    margin-left:auto;
    margin-right:auto;
    box-shadow:0 2px 5px rgba(0,0,0,.1);
    text-align:left;
}
.history-item{ border-bottom:1px solid #eee; padding:5px 0; }
</style>
</head>
<body>

<h2>Welcome</h2>
<p id="user"></p>
<div id="clock">00:00:00</div>

<h3>Attendance</h3>
<button id="inBtn" onclick="markIn()">‚úÖ I am in Office</button>
<button id="outBtn" onclick="markOut()">üö™ I am Leaving</button>

<div id="status"></div>

<div id="historyArea">
<h4>üìÖ Last 7 Days History</h4>
<div id="historyList"></div>
</div>

<button class="logout-btn" onclick="logout()">Logout</button>

<script>
const ATTENDANCE_SHEET = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQU4-KlIY732XZyhLAZB4-5pUrAcwiqO1bkhrVladSas6MT7ZK967vkNDPd_QzAu7rM72JnT5F5jDzL/pub?output=csv";
const PROXY = "https://api.allorigins.win/raw?url=";

const id = localStorage.getItem("userid");
const name = localStorage.getItem("name");

if(!id){ window.location.href="index.html"; }
document.getElementById("user").innerText = `ID: ${id} | Name: ${name}`;

const inBtn = document.getElementById("inBtn");
const outBtn = document.getElementById("outBtn");
const statusTxt = document.getElementById("status");

// Clock
function updateClock(){
    const now = new Date();
    document.getElementById("clock").innerText = now.toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

// Load Attendance History
function loadHistory(){
    const url = PROXY + encodeURIComponent(ATTENDANCE_SHEET);
    fetch(url)
    .then(res=>res.text())
    .then(data=>{
        Papa.parse(data,{
            header:true,
            skipEmptyLines:true,
            complete:function(res){
                displayHistory(res.data);
            }
        });
    }).catch(err=>console.error(err));
}

function displayHistory(rows){
    const list = document.getElementById("historyList");
    list.innerHTML="";
    const today = new Date();
    for(let i=0;i<7;i++){
        let d = new Date(); d.setDate(today.getDate()-i);
        let dayStr = `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;

        let record = rows.find(r=> (r.ID||"").trim() === id && (r.Date||"").trim() === dayStr);
        let html = record 
            ? `‚úÖ In: ${record.InTime || '---'} | Out: ${record.OutTime || '---'} | Status: ${record.Status || '---'}`
            : "‚ùå No Record";

        const div = document.createElement("div");
        div.className="history-item";
        div.innerHTML = `<strong>${i===0?"Today":dayStr}:</strong> ${html}`;
        list.appendChild(div);
    }
}

// Attendance Buttons (local only for demo)
function markIn(){ 
    const now = new Date();
    const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
    statusTxt.innerText = `‚úÖ Marked IN at ${timeStr}`;
    inBtn.disabled=true;
}

function markOut(){
    const now = new Date();
    const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
    statusTxt.innerText = `‚úÖ Marked OUT at ${timeStr}`;
    outBtn.disabled=true;
}

function logout(){
    localStorage.clear();
    window.location.href="index.html";
}

loadHistory();
</script>

</body>
</html>
