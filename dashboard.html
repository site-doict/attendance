<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Staff Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>

body{
    font-family: Arial, sans-serif;
    background:#f9f9f9;
    padding:20px;
    text-align:center;
}

#clock{
    font-size:28px;
    font-weight:bold;
    margin:15px 0;
}

button{
    padding:15px 25px;
    font-size:18px;
    margin:10px;
    cursor:pointer;
    border:none;
    border-radius:8px;
}

#inBtn{
    background:#28a745;
    color:white;
    display:none;
}

#outBtn{
    background:#dc3545;
    color:white;
    display:none;
}

.logout-btn{
    background:#6c757d;
    color:white;
}

#historyArea{
    margin-top:20px;
    background:white;
    padding:15px;
    border-radius:10px;
    max-width:600px;
    margin:auto;
    box-shadow:0 2px 5px rgba(0,0,0,.1);
    text-align:left;
}

.history-item{
    border-bottom:1px solid #eee;
    padding:6px 0;
}

#status{
    margin-top:10px;
    font-weight:bold;
}

#deviceMsg{
    display:none;
    background:#fff3cd;
    border:1px solid #ffc107;
    border-radius:8px;
    padding:15px 20px;
    margin:15px auto;
    max-width:400px;
    font-size:16px;
    color:#856404;
    line-height:1.6;
}

#loadingMsg{
    color:#888;
    font-size:15px;
    margin:10px 0;
}

</style>
</head>

<body>

<h2>Welcome</h2>

<p id="user"></p>

<div id="clock">00:00:00</div>

<h3>Attendance</h3>

<div id="loadingMsg">‚è≥ Checking device...</div>

<button id="inBtn" onclick="markIn()">‚úÖ I am in Office</button>
<button id="outBtn" onclick="markOut()">üö™ I am Leaving</button>

<div id="deviceMsg">
    ‚ö†Ô∏è This is not your registered device.<br><br>
    Please use your own device to mark attendance.<br>
    If you have an issue, please contact your officer.
</div>

<div id="status"></div>

<div id="historyArea">
    <h4>üìÖ Last 7 Days History</h4>
    <div id="historyList"></div>
</div>

<button class="logout-btn" onclick="logout()">Logout</button>


<script>

// ================= CONFIG =================

const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbz8aGa9gSSEDx4zTtbb8fhx9iW-wmx9bE7yf5FUBygZ69lG-1EgSgLJ-LBnomV_wNTY/exec";

// ================= OFFICE LOCATION =================
// TODO: Replace with your actual office coordinates
const OFFICE_LAT = 24.8946369;  // Office latitude
const OFFICE_LNG = 89.7183403;  // Office longitude
const MAX_DISTANCE_METERS = 100; // 100 meters radius


// ================= USER =================

const id   = localStorage.getItem("userid");
const name = localStorage.getItem("name");

if(!id){
    location.href="index.html";
}

document.getElementById("user").innerText =
`ID: ${id} | Name: ${name}`;


//
// ================= ELEMENTS =================
//

const inBtn     = document.getElementById("inBtn");
const outBtn    = document.getElementById("outBtn");
const statusTx  = document.getElementById("status");
const deviceMsg = document.getElementById("deviceMsg");
const loadingMsg= document.getElementById("loadingMsg");


//
// ================= CLOCK =================
//

function updateClock(){
    const now = new Date();
    document.getElementById("clock").innerText = now.toLocaleTimeString();
}

setInterval(updateClock,1000);
updateClock();


//
// ================= DEVICE FINGERPRINT =================
//

function getDeviceFingerprint(){

    const nav = window.navigator;
    const scr = window.screen;

    // Only use values that stay SAME in normal and incognito mode
    const raw = [
        nav.userAgent,                  // same in incognito
        nav.language,                   // same in incognito
        scr.width,                      // same in incognito
        scr.height,                     // same in incognito
        scr.colorDepth,                 // same in incognito
        new Date().getTimezoneOffset(), // same in incognito
        nav.platform || ""              // same in incognito
    ].join("|");

    // Simple hash
    let hash = 0;
    for(let i = 0; i < raw.length; i++){
        const char = raw.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }

    return Math.abs(hash).toString(16);
}


//
// ================= CHECK DEVICE VIA SHEET =================
//

function checkDeviceAndLoad(){

    const fp = getDeviceFingerprint();

    const url = `${WEB_APP_URL}?action=checkdevice&id=${id}&fp=${fp}`;

    fetch(url)

    .then(r => r.json())

    .then(res => {

        loadingMsg.style.display = "none";

        if(res.status === "blocked"){

            // Wrong device - show message
            deviceMsg.style.display = "block";
            inBtn.style.display     = "none";
            outBtn.style.display    = "none";

            // Still load history so they can see records
            loadHistory(false);

        } else {

            // allowed or registered (first time)
            deviceMsg.style.display = "none";
            loadHistory(true);
        }

    })

    .catch(err => {

        console.log("Device check failed:", err);
        loadingMsg.style.display = "none";

        // On error, still load history but hide buttons for safety
        loadHistory(false);
    });
}


//
// ================= LOAD HISTORY =================
//

let deviceAllowed = false;

function loadHistory(allowed){

    if(allowed !== undefined){
        deviceAllowed = allowed;
    }

    fetch(WEB_APP_URL + "?action=history&id=" + id)

    .then(r => r.json())

    .then(rows => {

        displayHistory(rows);

    })

    .catch(err => {

        console.log(err);
        statusTx.innerText = "‚ùå Load Failed";
    });
}



// ================= DISTANCE CALCULATOR =================
//

function getDistance(lat1, lng1, lat2, lng2){
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}


//
// ================= GET LOCATION & MARK =================
//

function getLocationAndMark(type, status){

    statusTx.innerText = "üìç Getting your location...";

    if(!navigator.geolocation){
        statusTx.innerText = "‚ùå Geolocation not supported on this device!";
        return;
    }

    navigator.geolocation.getCurrentPosition(

        function(pos){

            const userLat = pos.coords.latitude;
            const userLng = pos.coords.longitude;
            const dist    = getDistance(userLat, userLng, OFFICE_LAT, OFFICE_LNG);

            console.log("Distance from office:", dist, "meters");

            if(dist <= MAX_DISTANCE_METERS){
                sendData(status, type, userLat, userLng);
            } else {
                statusTx.innerText =
                `‚ùå You are ${Math.round(dist)}m away from office. Must be within ${MAX_DISTANCE_METERS}m!`;
            }
        },

        function(err){
            statusTx.innerText = "‚ùå Location access denied! Please allow location to mark attendance.";
        },

        { enableHighAccuracy: true, timeout: 10000 }
    );
}


//
// ================= BUTTON CONTROL =================
//

function controlButtons(rows){

    const now  = new Date();
    const mins = now.getHours()*60 + now.getMinutes();

    // TIME RULES (minutes)
    const IN_START  = 8*60+15;   // 08:15 AM - button appears
    const IN_CLOSE  = 10*60+30;  // 10:30 AM - button disappears
    const OUT_START = 15*60+30;  // 03:30 PM - button appears
    const OUT_CLOSE = 20*60;     // 08:00 PM - button disappears

    // Hide first
    inBtn.style.display  = "none";
    outBtn.style.display = "none";

    // If device not allowed, don't show buttons
    if(!deviceAllowed) return;

    // Today string
    const today    = new Date();
    const todayStr = `${today.getMonth()+1}/${today.getDate()}/${today.getFullYear()}`;

    // Find today's record
    const rec = rows.find(r =>
        String(r.id).trim() === id &&
        String(r.date).trim() === todayStr
    );

    // ---------- IN BUTTON ----------
    if(!rec || !rec.inTime || rec.inTime === "---" || rec.inTime === ""){
        if(mins >= IN_START && mins <= IN_CLOSE){
            inBtn.style.display = "inline-block";
            statusTx.innerText  = "";
        } else if(mins < IN_START){
            statusTx.innerText = "‚è∞ Sign In button opens at 8:15 AM";
        } else if(mins > IN_CLOSE){
            statusTx.innerText = "‚è∞ Sign In closed. Opens tomorrow at 8:15 AM";
        }
    }

    // ---------- OUT BUTTON ----------
    if(rec && rec.inTime && rec.inTime !== "---" && rec.inTime !== "" &&
      (!rec.outTime || rec.outTime === "---" || rec.outTime === "")){
        if(mins >= OUT_START && mins <= OUT_CLOSE){
            outBtn.style.display = "inline-block";
            statusTx.innerText   = "";
        } else if(mins < OUT_START){
            statusTx.innerText = "‚è∞ Sign Out button opens at 3:30 PM";
        } else if(mins > OUT_CLOSE){
            statusTx.innerText = "‚è∞ Sign Out closed for today";
        }
    }

    // ---------- ALREADY SIGNED IN AND OUT ----------
    if(rec && rec.inTime && rec.inTime !== "---" &&
       rec.outTime && rec.outTime !== "---"){
        statusTx.innerText = "‚úÖ Attendance complete for today!";
    }
}



//
// ================= DISPLAY HISTORY =================
//

function displayHistory(rows){

    const list = document.getElementById("historyList");
    list.innerHTML = "";

    const today = new Date();

    for(let i=0;i<7;i++){

        let d = new Date();
        d.setDate(today.getDate()-i);

        let dayStr = `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;

        let rec = rows.find(r =>
            String(r.id).trim() === id &&
            String(r.date).trim() === dayStr
        );

        let html = rec
        ? `‚úÖ In: ${rec.inTime||'---'} | Out: ${rec.outTime||'---'} | Status: ${rec.status||'---'}`
        : "‚ùå No Record";

        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `<strong>${i===0?"Today":dayStr}:</strong> ${html}`;
        list.appendChild(div);
    }

    controlButtons(rows);
}



//
// ================= SEND DATA =================
//

function sendData(status, type, lat, lng){

    const now = new Date();
    const fd  = new FormData();

    fd.append("id",id);
    fd.append("name",name);
    fd.append("status",status);
    fd.append("type",type);
    fd.append("lat", lat || "");
    fd.append("lng", lng || "");

    fetch(WEB_APP_URL,{
        method:"POST",
        body:fd
    })

    .then(r => r.json())

    .then(d => {

        if(d.success){

            let hours   = now.getHours();
            let minutes = String(now.getMinutes()).padStart(2,"0");
            let ampm    = hours >= 12 ? 'PM' : 'AM';
            hours       = hours % 12;
            hours       = hours ? hours : 12;

            const t = `${hours}:${minutes} ${ampm}`;

            statusTx.innerText =
            type==="in"
            ? `‚úÖ Marked IN at ${t}`
            : `‚úÖ Marked OUT at ${t}`;

            loadHistory();
        }

    })

    .catch(()=>{
        statusTx.innerText = "‚ùå Submit Failed";
    });
}



//
// ================= BUTTON ACTION =================
//

function markIn(){

    const now  = new Date();
    let mins   = now.getHours()*60 + now.getMinutes();
    let status = mins >= (10*60) ? "Late Entry" : "Present";
    getLocationAndMark("in", status);
}


function markOut(){

    const now  = new Date();
    let mins   = now.getHours()*60 + now.getMinutes();
    let status = mins < (16*60+45) ? "Early Leave" : "Present";
    getLocationAndMark("out", status);
}



//
// ================= LOGOUT =================
//

function logout(){
    localStorage.clear();
    location.href="index.html";
}



//
// ================= START =================
// Check device first, then load history

checkDeviceAndLoad();


</script>

</body>
</html>
