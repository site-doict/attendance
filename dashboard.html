<!DOCTYPE html>
<html>
<head>
<title>Attendance Dashboard</title>
<style>
    body{ font-family:Arial; background:#f9f9f9; padding:30px; text-align: center; }
    h2{ color:#0056b3; }
    #clock { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 20px; background: #eee; display: inline-block; padding: 10px 20px; border-radius: 10px; }
    button{ padding:12px 25px; font-size:16px; margin:10px 0; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer; }
    button:disabled{ background:#aaa; cursor:not-allowed; }
    #status{ margin-top:20px; font-weight:bold; color: #d9534f; }
    .logout-btn { background: #6c757d; margin-top: 50px; }
</style>
</head>
<body>

<h2>Welcome</h2>
<p id="user"></p>

<div id="clock">00:00:00</div>

<h3>Attendance</h3>

<!-- Buttons are hidden by default via style="display:none" -->
<button id="inBtn" onclick="markIn()" style="display:none;">âœ… I am in Office</button>
<button id="outBtn" onclick="markOut()" style="display:none;">ðŸšª I am Leaving</button>

<p id="status"></p>

<button class="logout-btn" onclick="logout()">Logout</button>

<script>
// Google Form URL
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf6vzUcheslghKL4nR-a7_GgN3VESLjazzfsaxnmTuEaIY0ow/formResponse";

// Login Info
const id = localStorage.getItem("userid");
const name = localStorage.getItem("name");

if(!id){ window.location.href="index.html"; }
document.getElementById("user").innerText = "ID: " + id + " | Name: " + name;

const inBtn = document.getElementById("inBtn");
const outBtn = document.getElementById("outBtn");
const statusTxt = document.getElementById("status");

// 1. LIVE CLOCK & BUTTON VISIBILITY LOGIC
function updateClock() {
    const now = new Date();
    const hour = now.getHours();
    const today = now.toLocaleDateString(); // Example: "30/01/2026"
    
    // Display Clock
    document.getElementById("clock").innerText = now.toLocaleTimeString();

    // Memory check: Did they already click today?
    const hasDoneIn = localStorage.getItem("lastInDate") === today;
    const hasDoneOut = localStorage.getItem("lastOutDate") === today;

    // Visibility Logic
    if (hour < 11) { 
        // Before 11 AM
        inBtn.style.display = hasDoneIn ? "none" : "inline-block"; 
        outBtn.style.display = "none";
        statusTxt.innerText = hasDoneIn ? "âœ… You already marked IN today" : "";
        statusTxt.style.color = "green";
    } 
    else if (hour >= 14 && hour < 21) { 
        // 2 PM to 9 PM
        inBtn.style.display = "none";
        outBtn.style.display = hasDoneOut ? "none" : "inline-block";
        statusTxt.innerText = hasDoneOut ? "âœ… You already marked OUT today" : "";
        statusTxt.style.color = "green";
    } 
    else { 
        // Between 11 AM and 2 PM OR Night
        inBtn.style.display = "none";
        outBtn.style.display = "none";
        statusTxt.innerText = "Attendance is currently closed.";
        statusTxt.style.color = "#d9534f";
    }
}

// Update clock every second
setInterval(updateClock, 1000);
updateClock(); // Run immediately on load

function getDateParts(){
    const d = new Date();
    return { year: d.getFullYear(), month: d.getMonth()+1, day: d.getDate() };
}

function getTimeParts(){
    const d = new Date();
    return { hour: d.getHours(), minute: d.getMinutes() };
}

function getLocation(cb){
    if(!navigator.geolocation){ cb("",""); return; }
    navigator.geolocation.getCurrentPosition(
        pos=>{ cb(pos.coords.latitude,pos.coords.longitude); },
        ()=>{ cb("",""); }
    );
}

function markIn(){
    const t = getTimeParts();
    const d = getDateParts();
    let status = t.hour > 9 ? "Late" : "Present";
    sendData(d,t,null,status);
}

function markOut(){
    const t = getTimeParts();
    const d = getDateParts();
    sendData(d,null,t,"Present");
}

function sendData(date, inTime, outTime, status) {
    statusTxt.innerText = "Processing... Please wait.";
    
    getLocation((lat, long) => {
        const fd = new FormData();
        const dateStr = `${date.day}/${date.month}/${date.year}`;
        const inStr = inTime ? `${inTime.hour}:${String(inTime.minute).padStart(2,"0")}` : "---";
        const outStr = outTime ? `${outTime.hour}:${String(outTime.minute).padStart(2,"0")}` : "---";

        fd.append("entry.1859002656", id);
        fd.append("entry.339531515", name);
        fd.append("entry.1163502489", dateStr);
        fd.append("entry.542167419", inStr);
        fd.append("entry.1532127027", outStr);
        fd.append("entry.1008700991", lat || "0");
        fd.append("entry.698099376", long || "0");
        fd.append("entry.1126631987", status);

        fetch(FORM_URL, { method: "POST", mode: "no-cors", body: fd })
       .then(() => {
            const today = new Date().toLocaleDateString();
            
            // Save to browser memory so button hides on refresh
            if (inTime) { localStorage.setItem("lastInDate", today); }
            if (outTime) { localStorage.setItem("lastOutDate", today); }

            statusTxt.style.color = "green";
            statusTxt.innerText = "âœ… Attendance Submitted Successfully!";
            inBtn.style.display = "none";
            outBtn.style.display = "none";
        })
        .catch((err) => {
            alert("Failed to connect. Check internet.");
        });
    });
}

function logout(){ localStorage.clear(); window.location.href="index.html"; }
</script>
</body>
</html>

