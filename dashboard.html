<!DOCTYPE html>
<html>
<head>
<title>Attendance Dashboard</title>
<style>

/* Base setup */
body{
    font-family: Arial, sans-serif;
    background:#f9f9f9;
    padding:15px;
    text-align:center;
    font-size:18px;   /* KEY FIX */
}


/* Headings */

h2{
    color:#0056b3;
    font-size:26px;
    margin-bottom:10px;
}

h3{
    font-size:22px;
}


/* User info */

#user{
    font-size:18px;
    margin-bottom:15px;
}


/* Clock */

#clock{
    font-size:28px;
    font-weight:bold;
    background:#eee;
    display:inline-block;
    padding:12px 20px;
    border-radius:10px;
    margin-bottom:20px;
}


/* Buttons */

button{
    width:100%;
    padding:16px;
    font-size:20px;
    margin:12px 0;
    background:#28a745;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
}

button:disabled{
    background:#aaa;
}


/* Status text */

#status{
    font-size:18px;
    margin-top:15px;
    min-height:25px;
}


/* History box */

#historyArea{
    margin-top:25px;
    background:white;
    padding:15px;
    border-radius:10px;
    box-shadow:0 2px 5px rgba(0,0,0,.1);
}


.history-item{
    display:flex;
    flex-direction:column;
    gap:5px;
    border-bottom:1px solid #eee;
    padding:10px 0;
    font-size:16px;
}


/* Logout */

.logout-btn{
    width:100%;
    background:#6c757d;
    font-size:18px;
    padding:14px;
    margin-top:30px;
    border-radius:8px;
}

</style>

</head>
<body>

<h2>Welcome</h2>
<p id="user"></p>
<div id="clock">00:00:00</div>

<h3>Attendance</h3>
<button id="inBtn" onclick="markIn()" style="display:none;">‚úÖ I am in Office</button>
<button id="outBtn" onclick="markOut()" style="display:none;">üö™ I am Leaving</button>

<p id="status"></p>

<div id="historyArea">
    <h4 style="margin-top:0; color:#0056b3;">üìÖ Last 7 Days History</h4>
    <div id="historyList"></div>
</div>

<button class="logout-btn" onclick="logout()">Logout</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
// --- CONFIGURATION ---
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf6vzUcheslghKL4nR-a7_GgN3VESLjazzfsaxnmTuEaIY0ow/formResponse";
// Put your Response Sheet CSV link here (same as admin link)
const SUMMARY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQU4-KlIY732XZyhLAZB4-5pUrAcwiqO1bkhrVladSas6MT7ZK967vkNDPd_QzAu7rM72JnT5F5jDzL/pub?output=csv";
//YOUR_WEB_APP_URL_HERE
const LIVE_SERVER_URL = "https://script.google.com/macros/s/AKfycbz6gKNDkaXj3dWPT8y_NHWSL-zVVwMI5qUg4sGImFyfM-rX2LGAiQMwSDeN_MFkkBM/exec";

const OFFICE_LAT = 24.8947079, OFFICE_LONG = 89.7182064, MAX_DISTANCE = 150;
const id = localStorage.getItem("userid"), name = localStorage.getItem("name");

if(!id){ window.location.href="index.html"; }
document.getElementById("user").innerText = `ID: ${id} | Name: ${name}`;

const inBtn = document.getElementById("inBtn"), outBtn = document.getElementById("outBtn"), statusTxt = document.getElementById("status");

// --- GLOBAL STATE TO PREVENT CHEATING ---
let serverHasIn = false;
let serverHasOut = false;

// 1. FETCH DATA FROM GOOGLE SHEETS (ANTI-CHEAT)
// Replace ONLY this function in your dashboard.html script
async function verifyWithServer() {
    statusTxt.innerText = "üîç Syncing with Live Server...";
    
    try {
        // This calls your Google Script directly for 0-second delay
        const response = await fetch(`${LIVE_SERVER_URL}?id=${id}`);
        const data = await response.json();
        
        serverHasIn = data.hasIn;
        serverHasOut = data.hasOut;
        
        updateClock(); 
        
        // Use the old CSV only for the 7-day history list
        loadHistoryFromServer(); 
    } catch (e) {
        console.log("Live check failed, using local memory.");
        updateClock();
    }
}

async function loadHistoryFromServer() {
    const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(SUMMARY_CSV);
    try {
        const res = await fetch(proxyUrl);
        const text = await res.text();
        Papa.parse(text, {
            header: true,
            delimiter: "\t",        // Important!
            skipEmptyLines: true,
            complete: function(results) {
                loadHistory(results.data);
            },
            error: function(err) {
                console.error("Parse error:", err);
            }
        });
    } catch(e) {
        console.error("Fetch failed:", e);
    }
}


function updateClock() {
    const now = new Date(), hour = now.getHours();
    document.getElementById("clock").innerText = now.toLocaleTimeString();
    const today = now.toLocaleDateString();

    // Combine Server Data + Local Cache for maximum security
    const hasIn = serverHasIn || (localStorage.getItem("lastInDate_" + id) === today);
    const hasOut = serverHasOut || (localStorage.getItem("lastOutDate_" + id) === today);

    if (hour < 11) {
        inBtn.style.display = hasIn ? "none" : "inline-block";
        outBtn.style.display = "none";
        statusTxt.innerText = hasIn ? "‚úÖ Already Marked IN (Server Verified)" : "";
    } else if (hour >= 14 && hour < 23) {
        inBtn.style.display = "none";
        outBtn.style.display = hasOut ? "none" : "inline-block";
        statusTxt.innerText = hasOut ? "‚úÖ Already Marked OUT (Server Verified)" : "";
    } else {
        inBtn.style.display = "none"; outBtn.style.display = "none";
        statusTxt.innerText = "Attendance Closed";
    }
}

// 2. SEND DATA
function sendData(status, isIn) {
    statusTxt.innerText = "üìç Verifying location...";
    navigator.geolocation.getCurrentPosition(pos => {
        const dist = getDistance(pos.coords.latitude, pos.coords.longitude, OFFICE_LAT, OFFICE_LONG);
        if (dist > MAX_DISTANCE) {
            statusTxt.className = "danger-box";
            statusTxt.innerHTML = `üö´ ILLEGAL ATTEMPT!<br>You are ${Math.round(dist)}m away.`;
            return;
        }

        const now = new Date();
        const dateStr = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
        const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,"0")}`;

        const fd = new FormData();
        fd.append("entry.1859002656", id);
        fd.append("entry.339531515", name);
        fd.append("entry.1163502489", dateStr);
        fd.append("entry.542167419", isIn ? timeStr : "---");
        fd.append("entry.1532127027", isIn ? "---" : timeStr);
        fd.append("entry.1008700991", pos.coords.latitude);
        fd.append("entry.698099376", pos.coords.longitude);
        fd.append("entry.1126631987", status);

        fetch(FORM_URL, { method: "POST", mode: "no-cors", body: fd }).then(() => {
            const today = now.toLocaleDateString();
            localStorage.setItem(isIn ? "lastInDate_"+id : "lastOutDate_"+id, today);
            statusTxt.innerText = "‚úÖ Submitted Successfully!";
            verifyWithServer(); // Sync immediately
        });
    });
}

function loadHistory(serverRecords = []) {
    const list = document.getElementById("historyList");
    list.innerHTML = "";
    // Show last 7 days from REAL server data
    for (let i = 0; i < 7; i++) {
        let d = new Date(); d.setDate(d.getDate() - i);
        let dateKey = d.toLocaleDateString();
        
        let dayRecord = serverRecords.find(r => r.ID == id && (r.Date || r.Timestamp || "").includes(dateKey));
        
        let statusHtml = dayRecord ? 
            `<span style='color:green;'>‚úÖ In: ${dayRecord.InTime} | Out: ${dayRecord.OutTime}</span>` : 
            `<span style='color:red;'>‚ùå No Record</span>`;

        const item = document.createElement("div");
        item.className = "history-item";
        item.innerHTML = `<span class="history-date">${i===0?"Today":dateKey}</span><span class="history-status">${statusHtml}</span>`;
        list.appendChild(item);
    }
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function markIn(){
    const h = new Date().getHours(), m = new Date().getMinutes();
    let s = (h === 10 && m <= 30) ? "Late" : (h >= 10 && m > 30) ? "Absent" : "Present";
    sendData(s, true);
}

function markOut(){
    const h = new Date().getHours(), m = new Date().getMinutes();
    let s = (h < 16 || (h === 16 && m < 20)) ? "Early Leave" : "Present";
    sendData(s, false);
}

function logout(){ localStorage.removeItem("userid"); localStorage.removeItem("name"); window.location.href="index.html"; }

setInterval(() => {
    updateClock();
}, 1000);

verifyWithServer(); // Initial sync
</script>

</body>
</html>














