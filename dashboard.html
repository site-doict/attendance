<!DOCTYPE html>
<html>
<head>
<title>Attendance Dashboard</title>
<style>
    body{ font-family:Arial; background:#f9f9f9; padding:30px; text-align: center; }
    h2{ color:#0056b3; }
    #clock { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 20px; background: #eee; display: inline-block; padding: 10px 20px; border-radius: 10px; }
    button{ padding:12px 25px; font-size:16px; margin:10px 0; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer; }
    button:disabled{ background:#aaa; cursor:not-allowed; }
    
    /* Updated Status Area */
    #status{ 
        margin-top:20px; 
        font-weight:bold; 
        color: #d9534f; 
        padding: 15px;
        border-radius: 8px;
        display: inline-block;
        min-width: 250px;
    }

    /* New Red Alert Box for Illegal Attempts */
    .danger-box {
        background: #ffebee;
        color: #c62828;
        border: 2px solid #ef5350;
        animation: shake 0.5s; /* Adds a small shake effect */
    }

    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
    }

#historyArea {
    margin-top: 30px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    text-align: left;
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.history-item {
    border-bottom: 1px solid #eee;
    padding: 8px 0;
    display: flex;
    justify-content: space-between;
    font-size: 14px;
}
.history-date { font-weight: bold; color: #555; }
.history-status { color: #28a745; font-weight: bold; }
    
    .logout-btn { background: #6c757d; margin-top: 50px; }
</style>

</head>
<body>

<h2>Welcome</h2>
<p id="user"></p>

<div id="clock">00:00:00</div>

<h3>Attendance</h3>

<!-- Buttons are hidden by default via style="display:none" -->
<button id="inBtn" onclick="markIn()" style="display:none;">‚úÖ I am in Office</button>
<button id="outBtn" onclick="markOut()" style="display:none;">üö™ I am Leaving</button>

<p id="status"></p>
<div id="historyArea">
    <h4 style="margin-top:0; color:#0056b3;">üìÖ Last 7 Days History</h4>
    <div id="historyList">Loading history...</div>
</div>
<button class="logout-btn" onclick="logout()">Logout</button>

<script>
// Google Form URL
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf6vzUcheslghKL4nR-a7_GgN3VESLjazzfsaxnmTuEaIY0ow/formResponse";

// Office Location: 24.8947079, 89.7182064
const OFFICE_LAT = 24.8947079; 
const OFFICE_LONG = 89.7182064;
const MAX_DISTANCE = 1500; // Metres

// This function will calculate distance
    function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth's radius in metres
    const œÜ1 = lat1 * Math.PI/180;
    const œÜ2 = lat2 * Math.PI/180;
    const ŒîœÜ = (lat2-lat1) * Math.PI/180;
    const ŒîŒª = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; 
}

    
// Login Info
const id = localStorage.getItem("userid");
const name = localStorage.getItem("name");

if(!id){ window.location.href="index.html"; }
document.getElementById("user").innerText = "ID: " + id + " | Name: " + name;

const inBtn = document.getElementById("inBtn");
const outBtn = document.getElementById("outBtn");
const statusTxt = document.getElementById("status");

// 1. LIVE CLOCK & BUTTON VISIBILITY LOGIC
function updateClock() {
    const now = new Date();
    const hour = now.getHours();
    const min = now.getMinutes();
    const today = now.toLocaleDateString(); 
    
    document.getElementById("clock").innerText = now.toLocaleTimeString();

    const hasDoneIn = localStorage.getItem("lastInDate_" + id) === today;
    const hasDoneOut = localStorage.getItem("lastOutDate_" + id) === today;

    // RULE: IN button only visible before 11:00 AM
    if (hour < 11) { 
        inBtn.style.display = hasDoneIn ? "none" : "inline-block"; 
        outBtn.style.display = "none";
        statusTxt.innerText = hasDoneIn ? "‚úÖ Already Marked IN" : "";
    } 
    // RULE: OUT button visible after 2:00 PM (14:00) until night
    else if (hour >= 14 && hour < 21) { 
        inBtn.style.display = "none";
        outBtn.style.display = hasDoneOut ? "none" : "inline-block";
        statusTxt.innerText = hasDoneOut ? "‚úÖ Already Marked OUT" : "";
    } 
    else { 
        inBtn.style.display = "none";
        outBtn.style.display = "none";
        // Show "Absent" message if they missed the 11 AM deadline
        statusTxt.innerText = (hour >= 11 && hour < 14 && !hasDoneIn) ? "‚ùå You are marked ABSENT (Late after 11 AM)" : "Attendance Closed";
    }
}


// Update clock every second
setInterval(updateClock, 1000);
updateClock(); // Run immediately on load

function getDateParts(){
    const d = new Date();
    return { year: d.getFullYear(), month: d.getMonth()+1, day: d.getDate() };
}

function getTimeParts(){
    const d = new Date();
    return { hour: d.getHours(), minute: d.getMinutes() };
}

function getLocation(cb){
    if(!navigator.geolocation){ cb("",""); return; }
    navigator.geolocation.getCurrentPosition(
        pos=>{ cb(pos.coords.latitude,pos.coords.longitude); },
        ()=>{ cb("",""); }
    );
}

function markIn(){
    const t = getTimeParts();
    const d = getDateParts();
    let status = "Present";

    // 9:00 - 10:00 -> Present
    // 10:01 - 10:30 -> Late
    // 10:31 - 11:00 -> Very Late (or Absent)
    
    if (t.hour === 10 && t.minute <= 30) {
        status = "Late";
    } else if (t.hour >= 10 && t.minute > 30) {
        status = "Absent";
    } else if (t.hour >= 11) {
        status = "Absent";
    }

    sendData(d, t, null, status);
}


function markOut(){
    const t = getTimeParts();
    const d = getDateParts();
    let status = "Present";

    // RULE: Out < 4:20 PM (16:20) -> Early Leave
    if (t.hour < 16 || (t.hour === 16 && t.minute < 20)) {
        status = "Early Leave";
    }

    sendData(d, null, t, status);
}


function sendData(date, inTime, outTime, status) {
    statusTxt.innerText = "üìç Verifying location...";
    statusTxt.className = ""; // Reset styling
    statusTxt.style.color = "orange";
    
    getLocation((lat, long) => {
        if (!lat || !long) {
            // NO ALERT HERE - USES ON-SCREEN BOX
            statusTxt.className = "danger-box";
            statusTxt.innerHTML = "üö´ GPS ERROR<br>Please enable location/GPS in your browser.";
            return;
        }

        // Calculate distance
        const distance = getDistance(lat, long, OFFICE_LAT, OFFICE_LONG);

                       if (distance > MAX_DISTANCE) {
            statusTxt.className = "danger-box";
            statusTxt.innerHTML = `
                <div style="font-size: 30px;">üö´</div>
                ILLEGAL ATTEMPT!<br>
                You are ${Math.round(distance)}m away.<br>
                <p style="font-size:12px; cursor:pointer; text-decoration:underline;" onclick="tryAgain()">Click here to try again</p>
            `;
            return; 
        }

        // --- If location is OK, proceed to send ---
        statusTxt.className = ""; 
        statusTxt.style.color = "blue";
        statusTxt.innerText = "üöÄ Sending to Sheet...";

        const fd = new FormData();
        const dateStr = `${date.day}/${date.month}/${date.year}`;
        const inStr = inTime ? `${inTime.hour}:${String(inTime.minute).padStart(2,"0")}` : "---";
        const outStr = outTime ? `${outTime.hour}:${String(outTime.minute).padStart(2,"0")}` : "---";

        fd.append("entry.1859002656", id);
        fd.append("entry.339531515", name);
        fd.append("entry.1163502489", dateStr);
        fd.append("entry.542167419", inStr);
        fd.append("entry.1532127027", outStr);
        fd.append("entry.1008700991", lat);
        fd.append("entry.698099376", long);
        fd.append("entry.1126631987", status);

        fetch(FORM_URL, { method: "POST", mode: "no-cors", body: fd })
        .then(() => {
            const today = new Date().toLocaleDateString();
            if (inTime) { localStorage.setItem("lastInDate_" + id, today); }
            if (outTime) { localStorage.setItem("lastOutDate_" + id, today); }

            statusTxt.className = "";
            statusTxt.style.color = "green";
            statusTxt.innerText = "‚úÖ Submitted Successfully!";
            inBtn.style.display = "none";
            outBtn.style.display = "none";

            loadHistory();
        })
        .catch(() => {
            // NO ALERT HERE - USES ON-SCREEN BOX
            statusTxt.className = "danger-box";
            statusTxt.innerText = "üì° Connection Failed. Check Internet.";
        });
    });
}

// Function to let users try again after moving closer
function tryAgain() {
    statusTxt.className = ""; // Remove the red box
    statusTxt.innerText = "üìç Re-verifying...";
    updateClock(); // Restart the visibility check
}

// Function to show history
function loadHistory() {
    const list = document.getElementById("historyList");
    list.innerHTML = "";
    
    for (let i = 0; i < 7; i++) {
        let d = new Date();
        d.setDate(d.getDate() - i);
        
        // This MUST match the format used in your sendData function
        let dateKey = d.toLocaleDateString(); 

        const hasIn = localStorage.getItem("lastInDate_" + id) === dateKey;
        const hasOut = localStorage.getItem("lastOutDate_" + id) === dateKey;

        let statusText = "<span style='color:red;'>‚ùå No Record</span>";
        if (hasIn && hasOut) statusText = "<span style='color:green;'>‚úÖ Full Day</span>";
        else if (hasIn) statusText = "<span style='color:orange;'>‚è≥ In Only</span>";
        else if (hasOut) statusText = "<span style='color:blue;'>üö™ Out Only</span>";

        const item = document.createElement("div");
        item.className = "history-item";
        item.innerHTML = `
            <span class="history-date">${i === 0 ? "Today" : dateKey}</span>
            <span class="history-status">${statusText}</span>
        `;
        list.appendChild(item);
    }
}


// Call this function when the page loads
loadHistory();


function logout(){
    // Only remove login session, DO NOT remove attendance records
    localStorage.removeItem("userid");
    localStorage.removeItem("name");
    window.location.href = "index.html";
}
</script>
</body>
</html>











