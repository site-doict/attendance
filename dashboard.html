<!DOCTYPE html>
<html>
<head>
<title>Attendance Dashboard</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    background:#f9f9f9;
    padding:15px;
    text-align:center;
    font-size:18px;
}
h2{ color:#0056b3; font-size:26px; margin-bottom:10px; }
h3{ font-size:22px; }
#user{ font-size:18px; margin-bottom:15px; }
#clock{
    font-size:28px;
    font-weight:bold;
    background:#eee;
    display:inline-block;
    padding:12px 20px;
    border-radius:10px;
    margin-bottom:20px;
}
button{
    width:100%;
    padding:16px;
    font-size:20px;
    margin:12px 0;
    background:#28a745;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
}
button:disabled{ background:#aaa; }
#status{ font-size:18px; margin-top:15px; min-height:25px; }
#historyArea{
    margin-top:25px;
    background:white;
    padding:15px;
    border-radius:10px;
    box-shadow:0 2px 5px rgba(0,0,0,.1);
}
.history-item{ display:flex; flex-direction:column; gap:5px; border-bottom:1px solid #eee; padding:10px 0; font-size:16px; }
.logout-btn{ width:100%; background:#6c757d; font-size:18px; padding:14px; margin-top:30px; border-radius:8px; }
</style>
</head>

<body>

<h2>Welcome</h2>
<p id="user"></p>
<div id="clock">00:00:00</div>

<h3>Attendance</h3>
<button id="inBtn" onclick="markIn()" style="display:none;">‚úÖ I am in Office</button>
<button id="outBtn" onclick="markOut()" style="display:none;">üö™ I am Leaving</button>

<p id="status"></p>

<div id="historyArea">
    <h4 style="margin-top:0; color:#0056b3;">üìÖ Last 7 Days History</h4>
    <div id="historyList"></div>
</div>

<button class="logout-btn" onclick="logout()">Logout</button>

<script>
// --- CONFIGURATION ---
const LIVE_SERVER_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // Your Google Apps Script Web App
const SUMMARY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQU4-KlIY732XZyhLAZB4-5pUrAcwiqO1bkhrVladSas6MT7ZK967vkNDPd_QzAu7rM72JnT5F5jDzL/pub?output=csv";
const PROXY = "https://api.allorigins.win/raw?url=";

const OFFICE_LAT = 24.8947079, OFFICE_LONG = 89.7182064, MAX_DISTANCE = 150;
const id = localStorage.getItem("userid"), name = localStorage.getItem("name");

if(!id){ window.location.href="index.html"; }
document.getElementById("user").innerText = `ID: ${id} | Name: ${name}`;

const inBtn = document.getElementById("inBtn"), outBtn = document.getElementById("outBtn"), statusTxt = document.getElementById("status");
let serverHasIn = false, serverHasOut = false;

// --- FETCH LIVE DATA ---
async function verifyWithServer() {
    statusTxt.innerText = "üîç Syncing with Live Server...";
    try {
        const res = await fetch(`${LIVE_SERVER_URL}?id=${id}`);
        const data = await res.json();
        serverHasIn = data.hasIn;
        serverHasOut = data.hasOut;
        updateClock();
        loadHistoryFromServer();
    } catch(e) {
        console.log("Server check failed, using local cache.");
        updateClock();
    }
}

// --- LOAD HISTORY ---
async function loadHistoryFromServer() {
    try {
        const res = await fetch(PROXY + encodeURIComponent(SUMMARY_CSV));
        const text = await res.text();
        Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const rows = results.data.filter(r => r.ID && r.ID.trim() !== ""); // ignore blank rows
                displayHistory(rows);
            }
        });
    } catch(e) { console.error("Failed to load history:", e); }
}

function displayHistory(rows) {
    const list = document.getElementById("historyList");
    list.innerHTML = "";
    for(let i=0;i<7;i++){
        const d = new Date(); d.setDate(d.getDate()-i);
        const dayStr = d.getDate() + '/' + (d.getMonth()+1) + '/' + d.getFullYear();
        const rec = rows.find(r => r.ID === id && r.Date === dayStr);
        const statusHtml = rec ? `‚úÖ In: ${rec.InTime} | Out: ${rec.OutTime}` : `‚ùå No Record`;
        const item = document.createElement("div");
        item.className = "history-item";
        item.innerHTML = `<span>${i===0 ? "Today" : dayStr}</span><span>${statusHtml}</span>`;
        list.appendChild(item);
    }
}

// --- CLOCK & BUTTON STATE ---
function updateClock() {
    const now = new Date();
    document.getElementById("clock").innerText = now.toLocaleTimeString();
    const today = now.getDate() + '/' + (now.getMonth()+1) + '/' + now.getFullYear();
    const hasIn = serverHasIn || (localStorage.getItem("lastInDate_"+id)===today);
    const hasOut = serverHasOut || (localStorage.getItem("lastOutDate_"+id)===today);

    const h = now.getHours();
    if(h < 11){ inBtn.style.display = hasIn ? "none" : "inline-block"; outBtn.style.display="none"; }
    else if(h >= 14 && h < 23){ inBtn.style.display="none"; outBtn.style.display = hasOut ? "none" : "inline-block"; }
    else { inBtn.style.display="none"; outBtn.style.display="none"; }

    statusTxt.innerText = hasIn && !hasOut ? "‚úÖ Already Marked IN" : hasOut ? "‚úÖ Already Marked OUT" : "";
}

// --- MARK IN / OUT ---
function getDistance(lat1, lon1, lat2, lon2){
    const R=6371e3, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

function sendData(isIn){
    statusTxt.innerText = "üìç Verifying location...";
    navigator.geolocation.getCurrentPosition(pos => {
        const dist = getDistance(pos.coords.latitude,pos.coords.longitude,OFFICE_LAT,OFFICE_LONG);
        if(dist > MAX_DISTANCE){ statusTxt.innerHTML=`üö´ ILLEGAL ATTEMPT! ${Math.round(dist)}m away.`; return; }

        const now = new Date();
        const dateStr = now.getDate() + '/' + (now.getMonth()+1) + '/' + now.getFullYear();
        const timeStr = now.getHours() + ':' + String(now.getMinutes()).padStart(2,"0");

        const fd = new FormData();
        fd.append("entry.1859002656", id);
        fd.append("entry.339531515", name);
        fd.append("entry.1163502489", dateStr);
        fd.append("entry.542167419", isIn ? timeStr : "---");
        fd.append("entry.1532127027", isIn ? "---" : timeStr);

        fetch("https://docs.google.com/forms/d/e/YOUR_FORM_ID/formResponse", { method:"POST", mode:"no-cors", body:fd })
        .then(() => {
            localStorage.setItem(isIn ? "lastInDate_"+id : "lastOutDate_"+id,dateStr);
            statusTxt.innerText = "‚úÖ Submitted Successfully!";
            verifyWithServer();
        });
    });
}

function markIn(){ sendData(true); }
function markOut(){ sendData(false); }

// --- LOGOUT ---
function logout(){ localStorage.removeItem("userid"); localStorage.removeItem("name"); localStorage.removeItem("role"); window.location.href="index.html"; }

setInterval(updateClock, 1000);
verifyWithServer();
</script>

</body>
</html>
