<!DOCTYPE html>
<html>
<head>
<title>Attendance Dashboard</title>
<style>
    body{ font-family:Arial; background:#f9f9f9; padding:30px; text-align: center; }
    h2{ color:#0056b3; }
    #clock { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 20px; background: #eee; display: inline-block; padding: 10px 20px; border-radius: 10px; }
    button{ padding:12px 25px; font-size:16px; margin:10px 0; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer; }
    #status{ margin-top:20px; font-weight:bold; color: #d9534f; padding: 15px; border-radius: 8px; display: inline-block; min-width: 250px; }
    .danger-box { background: #ffebee; color: #c62828; border: 2px solid #ef5350; animation: shake 0.5s; }
    @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
    #historyArea { margin-top: 30px; max-width: 400px; margin-left: auto; margin-right: auto; text-align: left; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .history-item { border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; font-size: 14px; }
    .history-date { font-weight: bold; color: #555; }
    .logout-btn { background: #6c757d; margin-top: 50px; color:white; padding:10px; border:none; border-radius:5px; cursor:pointer;}
</style>
</head>
<body>

<h2>Welcome</h2>
<p id="user"></p>
<div id="clock">00:00:00</div>

<h3>Attendance</h3>
<button id="inBtn" onclick="markIn()" style="display:none;">‚úÖ I am in Office</button>
<button id="outBtn" onclick="markOut()" style="display:none;">üö™ I am Leaving</button>

<p id="status"></p>

<div id="historyArea">
    <h4 style="margin-top:0; color:#0056b3;">üìÖ Last 7 Days History</h4>
    <div id="historyList"></div>
</div>

<button class="logout-btn" onclick="logout()">Logout</button>

<script src="https://cdn.jsdelivr.net"></script>
<script>
// --- CONFIGURATION ---
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf6vzUcheslghKL4nR-a7_GgN3VESLjazzfsaxnmTuEaIY0ow/formResponse";
// Put your Response Sheet CSV link here (same as admin link)
const SUMMARY_CSV = "https://docs.google.com/forms/d/e/1FAIpQLSf6vzUcheslghKL4nR-a7_GgN3VESLjazzfsaxnmTuEaIY0ow/formResponse";
//YOUR_WEB_APP_URL_HERE
const LIVE_SERVER_URL = "https://script.google.com/macros/s/AKfycbz6gKNDkaXj3dWPT8y_NHWSL-zVVwMI5qUg4sGImFyfM-rX2LGAiQMwSDeN_MFkkBM/exec";

const OFFICE_LAT = 24.8947079, OFFICE_LONG = 89.7182064, MAX_DISTANCE = 1500;
const id = localStorage.getItem("userid"), name = localStorage.getItem("name");

if(!id){ window.location.href="index.html"; }
document.getElementById("user").innerText = `ID: ${id} | Name: ${name}`;

const inBtn = document.getElementById("inBtn"), outBtn = document.getElementById("outBtn"), statusTxt = document.getElementById("status");

// --- GLOBAL STATE TO PREVENT CHEATING ---
let serverHasIn = false;
let serverHasOut = false;

// 1. FETCH DATA FROM GOOGLE SHEETS (ANTI-CHEAT)
// Replace ONLY this function in your dashboard.html script
async function verifyWithServer() {
    statusTxt.innerText = "üîç Syncing with Live Server...";
    
    try {
        // This calls your Google Script directly for 0-second delay
        const response = await fetch(`${LIVE_SERVER_URL}?id=${id}`);
        const data = await response.json();
        
        serverHasIn = data.hasIn;
        serverHasOut = data.hasOut;
        
        updateClock(); 
        
        // Use the old CSV only for the 7-day history list
        loadHistoryFromServer(); 
    } catch (e) {
        console.log("Live check failed, using local memory.");
        updateClock();
    }
}

async function loadHistoryFromServer() {
    try {
        const proxyUrl = "https://corsproxy.io" + encodeURIComponent(SUMMARY_CSV);
        const res = await fetch(proxyUrl);
        const text = await res.text();
        Papa.parse(text, {
            header: true,
            complete: function(results) {
                loadHistory(results.data);
            }
        });
    } catch (e) { console.log("History load failed."); }
}


function updateClock() {
    const now = new Date(), hour = now.getHours();
    document.getElementById("clock").innerText = now.toLocaleTimeString();
    const today = now.toLocaleDateString();

    // Combine Server Data + Local Cache for maximum security
    const hasIn = serverHasIn || (localStorage.getItem("lastInDate_" + id) === today);
    const hasOut = serverHasOut || (localStorage.getItem("lastOutDate_" + id) === today);

    if (hour < 11) {
        inBtn.style.display = hasIn ? "none" : "inline-block";
        outBtn.style.display = "none";
        statusTxt.innerText = hasIn ? "‚úÖ Already Marked IN (Server Verified)" : "";
    } else if (hour >= 14 && hour < 23) {
        inBtn.style.display = "none";
        outBtn.style.display = hasOut ? "none" : "inline-block";
        statusTxt.innerText = hasOut ? "‚úÖ Already Marked OUT (Server Verified)" : "";
    } else {
        inBtn.style.display = "none"; outBtn.style.display = "none";
        statusTxt.innerText = "Attendance Closed";
    }
}

// 2. SEND DATA
function sendData(status, isIn) {
    statusTxt.innerText = "üìç Verifying location...";
    navigator.geolocation.getCurrentPosition(pos => {
        const dist = getDistance(pos.coords.latitude, pos.coords.longitude, OFFICE_LAT, OFFICE_LONG);
        if (dist > MAX_DISTANCE) {
            statusTxt.className = "danger-box";
            statusTxt.innerHTML = `üö´ ILLEGAL ATTEMPT!<br>You are ${Math.round(dist)}m away.`;
            return;
        }

        const now = new Date();
        const dateStr = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
        const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,"0")}`;

        const fd = new FormData();
        fd.append("entry.1859002656", id);
        fd.append("entry.339531515", name);
        fd.append("entry.1163502489", dateStr);
        fd.append("entry.542167419", isIn ? timeStr : "---");
        fd.append("entry.1532127027", isIn ? "---" : timeStr);
        fd.append("entry.1008700991", pos.coords.latitude);
        fd.append("entry.698099376", pos.coords.longitude);
        fd.append("entry.1126631987", status);

        fetch(FORM_URL, { method: "POST", mode: "no-cors", body: fd }).then(() => {
            const today = now.toLocaleDateString();
            localStorage.setItem(isIn ? "lastInDate_"+id : "lastOutDate_"+id, today);
            statusTxt.innerText = "‚úÖ Submitted Successfully!";
            verifyWithServer(); // Sync immediately
        });
    });
}

function loadHistory(serverRecords = []) {
    const list = document.getElementById("historyList");
    list.innerHTML = "";
    // Show last 7 days from REAL server data
    for (let i = 0; i < 7; i++) {
        let d = new Date(); d.setDate(d.getDate() - i);
        let dateKey = d.toLocaleDateString();
        
        let dayRecord = serverRecords.find(r => r.ID == id && (r.Date || r.Timestamp || "").includes(dateKey));
        
        let statusHtml = dayRecord ? 
            `<span style='color:green;'>‚úÖ In: ${dayRecord.InTime} | Out: ${dayRecord.OutTime}</span>` : 
            `<span style='color:red;'>‚ùå No Record</span>`;

        const item = document.createElement("div");
        item.className = "history-item";
        item.innerHTML = `<span class="history-date">${i===0?"Today":dateKey}</span><span class="history-status">${statusHtml}</span>`;
        list.appendChild(item);
    }
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function markIn(){
    const h = new Date().getHours(), m = new Date().getMinutes();
    let s = (h === 10 && m <= 30) ? "Late" : (h >= 10 && m > 30) ? "Absent" : "Present";
    sendData(s, true);
}

function markOut(){
    const h = new Date().getHours(), m = new Date().getMinutes();
    let s = (h < 16 || (h === 16 && m < 20)) ? "Early Leave" : "Present";
    sendData(s, false);
}

function logout(){ localStorage.removeItem("userid"); localStorage.removeItem("name"); window.location.href="index.html"; }

setInterval(updateClock, 1000);
verifyWithServer(); // Initial sync
</script>

</body>
</html>



