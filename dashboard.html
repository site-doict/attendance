<!DOCTYPE html>
<html>
<head>
<title>Attendance Dashboard</title>
<style>
    body{ font-family:Arial; background:#f9f9f9; padding:30px; text-align: center; }
    h2{ color:#0056b3; }
    #clock { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 20px; background: #eee; display: inline-block; padding: 10px 20px; border-radius: 10px; }
    button{ padding:12px 25px; font-size:16px; margin:10px 0; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer; }
    button:disabled{ background:#aaa; cursor:not-allowed; }
    
    /* Updated Status Area */
    #status{ 
        margin-top:20px; 
        font-weight:bold; 
        color: #d9534f; 
        padding: 15px;
        border-radius: 8px;
        display: inline-block;
        min-width: 250px;
    }

    /* New Red Alert Box for Illegal Attempts */
    .danger-box {
        background: #ffebee;
        color: #c62828;
        border: 2px solid #ef5350;
        animation: shake 0.5s; /* Adds a small shake effect */
    }

    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
    }

    .logout-btn { background: #6c757d; margin-top: 50px; }
</style>

</head>
<body>

<h2>Welcome</h2>
<p id="user"></p>

<div id="clock">00:00:00</div>

<h3>Attendance</h3>

<!-- Buttons are hidden by default via style="display:none" -->
<button id="inBtn" onclick="markIn()" style="display:none;">‚úÖ I am in Office</button>
<button id="outBtn" onclick="markOut()" style="display:none;">üö™ I am Leaving</button>

<p id="status"></p>

<button class="logout-btn" onclick="logout()">Logout</button>

<script>
// Google Form URL
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf6vzUcheslghKL4nR-a7_GgN3VESLjazzfsaxnmTuEaIY0ow/formResponse";

// Office Location: 24.8947079, 89.7182064
const OFFICE_LAT = 24.8947079; 
const OFFICE_LONG = 89.7182064;
const MAX_DISTANCE = 150; // Metres

// This function will calculate distance
    function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth's radius in metres
    const œÜ1 = lat1 * Math.PI/180;
    const œÜ2 = lat2 * Math.PI/180;
    const ŒîœÜ = (lat2-lat1) * Math.PI/180;
    const ŒîŒª = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; 
}

    
// Login Info
const id = localStorage.getItem("userid");
const name = localStorage.getItem("name");

if(!id){ window.location.href="index.html"; }
document.getElementById("user").innerText = "ID: " + id + " | Name: " + name;

const inBtn = document.getElementById("inBtn");
const outBtn = document.getElementById("outBtn");
const statusTxt = document.getElementById("status");

// 1. LIVE CLOCK & BUTTON VISIBILITY LOGIC
function updateClock() {
    const now = new Date();
    const hour = now.getHours();
    const today = now.toLocaleDateString(); 
    
    document.getElementById("clock").innerText = now.toLocaleTimeString();

    // Memory check: Tied to the specific Logged-in ID
    const hasDoneIn = localStorage.getItem("lastInDate_" + id) === today;
    const hasDoneOut = localStorage.getItem("lastOutDate_" + id) === today;

    if (hour < 11) { 
        inBtn.style.display = hasDoneIn ? "none" : "inline-block"; 
        outBtn.style.display = "none";
        statusTxt.innerText = hasDoneIn ? "‚úÖ You already marked IN today" : "";
        statusTxt.style.color = "green";
    } 
    else if (hour >= 14 && hour < 21) { 
        inBtn.style.display = "none";
        outBtn.style.display = hasDoneOut ? "none" : "inline-block";
        statusTxt.innerText = hasDoneOut ? "‚úÖ You already marked OUT today" : "";
        statusTxt.style.color = "green";
    } 
    else { 
        inBtn.style.display = "none";
        outBtn.style.display = "none";
        statusTxt.innerText = "Attendance is currently closed.";
        statusTxt.style.color = "#d9534f";
    }
}

// Update clock every second
setInterval(updateClock, 1000);
updateClock(); // Run immediately on load

function getDateParts(){
    const d = new Date();
    return { year: d.getFullYear(), month: d.getMonth()+1, day: d.getDate() };
}

function getTimeParts(){
    const d = new Date();
    return { hour: d.getHours(), minute: d.getMinutes() };
}

function getLocation(cb){
    if(!navigator.geolocation){ cb("",""); return; }
    navigator.geolocation.getCurrentPosition(
        pos=>{ cb(pos.coords.latitude,pos.coords.longitude); },
        ()=>{ cb("",""); }
    );
}

function markIn(){
    const t = getTimeParts();
    const d = getDateParts();
    let status = t.hour > 9 ? "Late" : "Present";
    sendData(d,t,null,status);
}

function markOut(){
    const t = getTimeParts();
    const d = getDateParts();
    sendData(d,null,t,"Present");
}

function sendData(date, inTime, outTime, status) {
    statusTxt.innerText = "üìç Verifying location...";
    statusTxt.style.color = "orange";
    
    getLocation((lat, long) => {
        if (!lat || !long) {
            alert("Location is required. Please enable GPS.");
            statusTxt.innerText = "‚ùå Location Error";
            return;
        }

        // Calculate distance
        const distance = getDistance(lat, long, OFFICE_LAT, OFFICE_LONG);

        if (distance > MAX_DISTANCE) {
            statusTxt.style.color = "red";
            statusTxt.innerHTML = `‚ö†Ô∏è Access Denied!<br>You are ${Math.round(distance)}m away.<br>Please enter office territory.`;
            alert("You are not in the office territory!");
            return; // This STOPS the submission
        }

        // --- If location is OK, proceed to send ---
        const fd = new FormData();
        const dateStr = `${date.day}/${date.month}/${date.year}`;
        const inStr = inTime ? `${inTime.hour}:${String(inTime.minute).padStart(2,"0")}` : "---";
        const outStr = outTime ? `${outTime.hour}:${String(outTime.minute).padStart(2,"0")}` : "---";

        fd.append("entry.1859002656", id);
        fd.append("entry.339531515", name);
        fd.append("entry.1163502489", dateStr);
        fd.append("entry.542167419", inStr);
        fd.append("entry.1532127027", outStr);
        fd.append("entry.1008700991", lat);
        fd.append("entry.698099376", long);
        fd.append("entry.1126631987", status);

        fetch(FORM_URL, { method: "POST", mode: "no-cors", body: fd })
        .then(() => {
            const today = new Date().toLocaleDateString();
            if (inTime) { localStorage.setItem("lastInDate_" + id, today); }
            if (outTime) { localStorage.setItem("lastOutDate_" + id, today); }

            statusTxt.style.color = "green";
            statusTxt.innerText = "‚úÖ Submitted Successfully!";
            inBtn.style.display = "none";
            outBtn.style.display = "none";
        })
        .catch(() => alert("Connection error."));
    });
}


function logout(){
    // Only remove login session, DO NOT remove attendance records
    localStorage.removeItem("userid");
    localStorage.removeItem("name");
    window.location.href = "index.html";
}
</script>
</body>
</html>




