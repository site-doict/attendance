<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Office Attendance</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a1a1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Office Attendance">
<link rel="apple-touch-icon" href="icon-192.png">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
*{ box-sizing: border-box; }

body{
    font-family: Arial, sans-serif;
    background: #f9f9f9;
    padding: 20px;
    text-align: center;
}

#clock{
    font-size: 28px;
    font-weight: bold;
    margin: 15px 0;
}

button{
    padding: 15px 25px;
    font-size: 18px;
    margin: 10px;
    cursor: pointer;
    border: none;
    border-radius: 8px;
}

#inBtn{
    background: #28a745;
    color: white;
    display: none;
}

#outBtn{
    background: #dc3545;
    color: white;
    display: none;
}

.logout-btn{
    background: #6c757d;
    color: white;
}

#historyArea{
    margin-top: 20px;
    background: white;
    padding: 15px;
    border-radius: 10px;
    max-width: 600px;
    margin: 20px auto;
    box-shadow: 0 2px 5px rgba(0,0,0,.1);
    text-align: left;
}

.history-item{
    border-bottom: 1px solid #eee;
    padding: 6px 0;
    font-size: 14px;
}

#status{
    margin-top: 10px;
    font-weight: bold;
    font-size: 15px;
}

#statusBox{
    display: none;
    margin: 15px auto;
    max-width: 420px;
    padding: 15px 20px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
}

#loadingMsg{
    color: #888;
    font-size: 15px;
    margin: 10px 0;
}

#deviceMsg, #fraudMsg{
    display: none;
    background: #dc3545;
    border-radius: 12px;
    padding: 20px;
    margin: 15px auto;
    max-width: 420px;
    color: white;
    font-size: 17px;
    font-weight: bold;
    line-height: 1.9;
    box-shadow: 0 4px 15px rgba(220,53,69,0.5);
    animation: pulse 1.2s infinite;
}

@keyframes pulse{
    0%  { box-shadow: 0 0 0 0    rgba(220,53,69,0.7); }
    70% { box-shadow: 0 0 0 15px rgba(220,53,69,0);   }
    100%{ box-shadow: 0 0 0 0    rgba(220,53,69,0);   }
}
</style>
</head>

<body>

<h2>Welcome</h2>
<p id="user"></p>
<div id="clock">00:00:00</div>

<div id="loadingMsg">‚è≥ Checking device...</div>

<button id="inBtn"  onclick="markIn()">‚úÖ I am in Office</button>

<div id="deviceMsg">
    üö® ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ! üö®<br><br>
    ‡¶è‡¶á ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡¶ü‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶®‡¶Ø‡¶º!<br><br>
    ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡¶æ‡¶∞‡ßã ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶õ‡ßá‡¶®‡•§
    ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡¶∞ ‡¶Ö‡¶™‡¶∞‡¶æ‡¶ß ‡¶è‡¶¨‡¶Ç ‡¶è‡¶á ‡¶§‡¶•‡ßç‡¶Ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§<br><br>
    ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶ú‡¶∏‡ßç‡¶¨ ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§<br>
    ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§<br><br>
    <span style="font-size:14px; font-weight:normal;">
        ‚ö†Ô∏è ‡¶Ö‡¶®‡ßç‡¶Ø‡ßá‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶∂‡¶æ‡¶∏‡ßç‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶Ö‡¶™‡¶∞‡¶æ‡¶ß‡•§
    </span>
</div>

<div id="fraudMsg"></div>

<div id="statusBox"></div>
<div id="status"></div>

<button id="outBtn" onclick="markOut()">üö™ I am Leaving</button>

<div id="historyArea">
    <h4>üìÖ Last 7 Days History</h4>
    <div id="historyList"></div>
</div>

<button class="logout-btn" onclick="logout()">Logout</button>

<script>

// ================= SERVICE WORKER =================
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js')
    .then(() => console.log("SW registered"))
    .catch(err => console.log("SW error:", err));
}

// ================= CONFIG =================
const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbz8aGa9gSSEDx4zTtbb8fhx9iW-wmx9bE7yf5FUBygZ69lG-1EgSgLJ-LBnomV_wNTY/exec";

const OFFICE_LAT          = 24.8946369;
const OFFICE_LNG          = 89.7183403;
const MAX_DISTANCE_METERS = 100;

// ================= USER =================
const id   = localStorage.getItem("userid");
const name = localStorage.getItem("name");

if(!id){ location.href = "index.html"; }

document.getElementById("user").innerText = `ID: ${id} | Name: ${name}`;

// ================= ELEMENTS =================
const inBtn      = document.getElementById("inBtn");
const outBtn     = document.getElementById("outBtn");
const statusTx   = document.getElementById("status");
const deviceMsg  = document.getElementById("deviceMsg");
const loadingMsg = document.getElementById("loadingMsg");
const fraudMsg   = document.getElementById("fraudMsg");

// ================= CLOCK =================
function updateClock(){
    document.getElementById("clock").innerText = new Date().toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

// ================= DEVICE FINGERPRINT =================
function getDeviceFingerprint(){
    const scr = window.screen;
    const nav = window.navigator;

    // These values are GUARANTEED same in ALL browsers on same device
    const raw = [
        scr.width,                       // physical screen width
        scr.height,                      // physical screen height
        scr.colorDepth,                  // color depth
        new Date().getTimezoneOffset(),  // timezone offset
        nav.language || nav.userLanguage || "" // system language
    ].join("|");

    let hash = 0;
    for(let i = 0; i < raw.length; i++){
        hash = ((hash << 5) - hash) + raw.charCodeAt(i);
        hash = hash & hash;
    }
    return Math.abs(hash).toString(16);
}

// ================= CHECK DEVICE =================
let deviceAllowed = false;

function checkDeviceAndLoad(){
    const fp  = getDeviceFingerprint();
    const url = `${WEB_APP_URL}?action=checkdevice&id=${id}&fp=${fp}`;

    fetch(url)
    .then(r => r.json())
    .then(res => {
        loadingMsg.style.display = "none";
        if(res.status === "blocked"){
            deviceMsg.style.display = "block";
            inBtn.style.display     = "none";
            outBtn.style.display    = "none";
            loadHistory(false);
        } else {
            deviceAllowed = true;
            deviceMsg.style.display = "none";
            loadHistory(true);
        }
    })
    .catch(err => {
        console.log("Device check failed:", err);
        loadingMsg.style.display = "none";
        loadHistory(false);
    });
}

// ================= LOAD HISTORY =================
function loadHistory(allowed){
    if(allowed !== undefined) deviceAllowed = allowed;

    fetch(`${WEB_APP_URL}?action=history&id=${id}`)
    .then(r => r.json())
    .then(rows => displayHistory(rows))
    .catch(err => {
        console.log(err);
        statusTx.innerText = "‚ùå Load Failed. Please try again.";
    });
}

// ================= DISTANCE =================
function getDistance(lat1, lng1, lat2, lng2){
    const R    = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a    =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) *
        Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLng/2) * Math.sin(dLng/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// ================= GET LOCATION & MARK =================
function getLocationAndMark(type, status){
    statusTx.innerText = "üìç ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶£‡¶Ø‡¶º ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
    fraudMsg.style.display = "none";

    if(!navigator.geolocation){
        statusTx.innerText = "‚ùå Geolocation not supported on this device!";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        function(pos){
            const userLat = pos.coords.latitude;
            const userLng = pos.coords.longitude;
            const dist    = getDistance(userLat, userLng, OFFICE_LAT, OFFICE_LNG);

            console.log("Distance:", Math.round(dist), "m");

            if(dist <= MAX_DISTANCE_METERS){
                sendData(status, type, userLat, userLng);
            } else {
                fraudMsg.style.display = "block";
                fraudMsg.innerHTML = `
                    üö® ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ! üö®<br><br>
                    ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶•‡ßá‡¶ï‡ßá <strong>${Math.round(dist)} ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞</strong> ‡¶¶‡ßÇ‡¶∞‡ßá ‡¶Ü‡¶õ‡ßá‡¶®!<br><br>
                    ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶•‡ßá‡¶ï‡ßá ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶õ‡ßá‡¶®‡•§<br>
                    ‡¶è‡¶á ‡¶§‡¶•‡ßç‡¶Ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§<br><br>
                    ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶´‡¶ø‡¶∏‡ßá ‡¶è‡¶∏‡ßá ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø ‡¶¶‡¶ø‡¶®‡•§<br><br>
                    <span style="font-size:14px; font-weight:normal;">
                    ‚ö†Ô∏è ‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶∂‡¶æ‡¶∏‡ßç‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶Ö‡¶™‡¶∞‡¶æ‡¶ß‡•§
                    </span>
                `;
                statusTx.innerText = "";
            }
        },
        function(err){
            statusTx.innerText = "‚ùå ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏ ‡¶¨‡¶®‡ßç‡¶ß ‡¶Ü‡¶õ‡ßá! ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø ‡¶¶‡¶ø‡¶§‡ßá ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

// ================= BUTTON CONTROL =================
function showStatusBox(msg, type){
    const box = document.getElementById("statusBox");
    box.style.display = "block";
    box.innerText = msg;

    if(type === "red"){
        box.style.background = "#fff0f0";
        box.style.color      = "#cc0000";
        box.style.border     = "2px solid #cc0000";
    } else if(type === "green"){
        box.style.background = "#f0fff4";
        box.style.color      = "#1a7a2e";
        box.style.border     = "2px solid #28a745";
    } else if(type === "blue"){
        box.style.background = "#f0f4ff";
        box.style.color      = "#0044cc";
        box.style.border     = "2px solid #0056b3";
    } else if(type === "orange"){
        box.style.background = "#fff8f0";
        box.style.color      = "#cc6600";
        box.style.border     = "2px solid #e67e00";
    }
}

function controlButtons(rows){
    const now     = new Date();
    const mins    = now.getHours() * 60 + now.getMinutes();
    const dayOfWk = now.getDay(); // 0=Sunday, 5=Friday, 6=Saturday

    const IN_START  = 8*60 + 15;  // 08:15 AM
    const IN_CLOSE  = 10*60 + 30; // 10:30 AM
    const OUT_START = 15*60 + 30; // 03:30 PM
    const OUT_CLOSE = 22*60;      // 08:00 PM

    inBtn.style.display  = "none";
    outBtn.style.display = "none";
    document.getElementById("statusBox").style.display = "none";
    statusTx.innerText = "";

    if(!deviceAllowed) return;

    // ========== HOLIDAY CHECK (Friday=5, Saturday=6) ==========
    if(dayOfWk === 5 || dayOfWk === 6){
        const dayName = dayOfWk === 5 ? "Friday" : "Saturday";
        showStatusBox(
            "üèñÔ∏è ‡¶Ü‡¶ú ‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶õ‡ßÅ‡¶ü‡¶ø‡¶∞ ‡¶¶‡¶ø‡¶® (" + dayName + ")!\n\n" +
            "‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶¨‡¶®‡ßç‡¶ß ‡¶Ü‡¶õ‡ßá‡•§ ‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶¶‡¶ø‡¶¨‡¶∏‡ßá ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®‡•§",
        "orange");
        return;
    }

    const today    = new Date();
    const todayStr = `${today.getMonth()+1}/${today.getDate()}/${today.getFullYear()}`;

    const rec = rows.find(r =>
        String(r.id).trim() === id &&
        String(r.date).trim() === todayStr
    );

    // ========== ALREADY COMPLETE ==========
    if(rec && rec.inTime && rec.inTime !== "---" &&
       rec.outTime && rec.outTime !== "---"){
        showStatusBox("‚úÖ Attendance complete for today!", "green");
        return;
    }

    // ========== NO SIGN IN YET ==========
    if(!rec || !rec.inTime || rec.inTime === "---" || rec.inTime === ""){

        if(mins >= IN_START && mins <= IN_CLOSE){
            // Normal sign in window - show button
            inBtn.style.display = "inline-block";

        } else if(mins < IN_START){
            showStatusBox("üî¥ Sign In button opens at 8:15 AM", "red");

        } else if(mins > IN_CLOSE && mins < OUT_START){
            // Very late - show message only, NO sheet entry yet
            showStatusBox(
                "‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶®‡ßá‡¶ï ‡¶¶‡ßá‡¶∞‡¶ø‡¶§‡ßá ‡¶Ö‡¶´‡¶ø‡¶∏‡ßá ‡¶è‡¶∏‡ßá‡¶õ‡ßá‡¶®!\n\n" +
                "‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§\n\n" +
                "‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Sign Out ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶π‡¶¨‡ßá ‡¶¨‡¶ø‡¶ï‡¶æ‡¶≤ ‡ß©:‡ß©‡ß¶ ‡¶ü‡¶æ‡¶Ø‡¶º‡•§",
            "red");
            // Show sign out button below message
            outBtn.style.display = "inline-block";

        } else if(mins >= OUT_START && mins <= OUT_CLOSE){
            // Very late, sign out window open - show message then button
            showStatusBox(
                "‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶®‡ßá‡¶ï ‡¶¶‡ßá‡¶∞‡¶ø‡¶§‡ßá ‡¶Ö‡¶´‡¶ø‡¶∏‡ßá ‡¶è‡¶∏‡ßá‡¶õ‡ßá‡¶®!\n\n" +
                "‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§\n\n" +
                "‚úÖ ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá Sign Out ‡¶ï‡¶∞‡ßÅ‡¶® ‚Üì‡•§",
            "red");
            outBtn.style.display = "inline-block";

        } else {
            showStatusBox("üî¥ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∂‡ßá‡¶∑‡•§ ‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ‡¶ï‡¶æ‡¶≤ ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ßÆ:‡ßß‡ß´ ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá‡•§", "red");
        }
        return;
    }

    // ========== SIGNED IN, NOT SIGNED OUT YET ==========
    if(rec && rec.inTime && rec.inTime !== "---" &&
      (!rec.outTime || rec.outTime === "---" || rec.outTime === "")){

        if(mins >= OUT_START && mins <= OUT_CLOSE){
            // Message first, then button
            if(rec.status === "Very Late"){
                showStatusBox(
                    "‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶®‡ßá‡¶ï ‡¶¶‡ßá‡¶∞‡¶ø‡¶§‡ßá ‡¶Ö‡¶´‡¶ø‡¶∏‡ßá ‡¶è‡¶∏‡ßá‡¶õ‡ßá‡¶®!\n\n" +
                    "‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§\n\n" +
                    "‚úÖ ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá Sign Out ‡¶ï‡¶∞‡ßÅ‡¶® ‚Üì‡•§",
                "red");
            }
            outBtn.style.display = "inline-block";

        } else if(mins < OUT_START){
            showStatusBox("üîµ Sign Out button opens at 3:30 PM", "blue");
        } else {
            showStatusBox("üî¥ Sign Out closed for today", "red");
        }
    }
}

// ================= DISPLAY HISTORY =================
function displayHistory(rows){
    const list = document.getElementById("historyList");
    list.innerHTML = "";
    const today = new Date();

    for(let i = 0; i < 7; i++){
        let d = new Date();
        d.setDate(today.getDate() - i);
        let dayStr = `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;

        let rec = rows.find(r =>
            String(r.id).trim() === id &&
            String(r.date).trim() === dayStr
        );

        let html = rec
            ? `‚úÖ In: ${rec.inTime||'---'} | Out: ${rec.outTime||'---'} | Status: ${rec.status||'---'}`
            : "‚ùå No Record";

        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `<strong>${i===0 ? "Today" : dayStr}:</strong> ${html}`;
        list.appendChild(div);
    }

    controlButtons(rows);
}

// ================= SEND DATA =================
function sendData(status, type, lat, lng){
    const now = new Date();
    const fd  = new FormData();

    fd.append("id",     id);
    fd.append("name",   name);
    fd.append("status", status);
    fd.append("type",   type);
    fd.append("lat",    lat || "");
    fd.append("lng",    lng || "");

    fetch(WEB_APP_URL, {
        method: "POST",
        body: fd,
        redirect: "follow"
    })
    .then(r => r.text())
    .then(text => {
        let d;
        try {
            // Strip any BOM or extra chars before JSON
            const clean = text.replace(/^\uFEFF/, "").trim();
            d = JSON.parse(clean);
        } catch(e){
            // If not JSON but request went through, treat as success
            d = { success: true };
        }

        if(d.success){
            let hours   = now.getHours();
            let minutes = String(now.getMinutes()).padStart(2, "0");
            let ampm    = hours >= 12 ? 'PM' : 'AM';
            hours       = hours % 12 || 12;
            const t     = `${hours}:${minutes} ${ampm}`;

            statusTx.innerText = type.includes("in")
                ? `‚úÖ Marked IN at ${t}`
                : `‚úÖ Marked OUT at ${t}`;

            loadHistory();

            if("Notification" in window && Notification.permission === "granted"){
                new Notification("Attendance Updated", {
                    body: statusTx.innerText,
                    icon: "icon-192.png"
                });
            }
        }
    })
    .catch(() => {
        // Network error - but data may have been saved, reload to check
        setTimeout(() => loadHistory(), 2000);
        statusTx.innerText = "‚è≥ Please wait...";
    });
}

// ================= BUTTON ACTIONS =================
function markIn(){
    const now  = new Date();
    const mins = now.getHours() * 60 + now.getMinutes();
    const status = mins >= 10*60 ? "Late Entry" : "Present";
    getLocationAndMark("in", status);
}

function markOut(){
    const now  = new Date();
    const mins = now.getHours() * 60 + now.getMinutes();
    const status = mins < (16*60 + 45) ? "Early Leave" : "Present";

    // Check if there's a today record - if no inTime, it's very late
    const today    = new Date();
    const todayStr = `${today.getMonth()+1}/${today.getDate()}/${today.getFullYear()}`;

    // Get latest rows from history
    fetch(`${WEB_APP_URL}?action=history&id=${id}`)
    .then(r => r.json())
    .then(rows => {
        const rec = rows.find(r =>
            String(r.id).trim() === id &&
            String(r.date).trim() === todayStr
        );

        const hasSignIn = rec && rec.inTime && rec.inTime !== "---" && rec.inTime !== "";

        if(!hasSignIn){
            // Very late - no sign in recorded yet, send as verylate+out combined
            getLocationAndMark("out-verylate", status);
        } else {
            getLocationAndMark("out", status);
        }
    })
    .catch(() => {
        // On error, just send normal out
        getLocationAndMark("out", status);
    });
}

// ================= LOGOUT =================
function logout(){
    localStorage.clear();
    location.href = "index.html";
}

// ================= PUSH PERMISSION =================
if("Notification" in window &&
   Notification.permission !== "granted" &&
   Notification.permission !== "denied"){
    Notification.requestPermission();
}

// ================= START =================
checkDeviceAndLoad();

</script>
</body>
</html>

