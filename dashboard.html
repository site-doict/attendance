<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Office Attendance</title>

<!-- ===== PWA ===== -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a1a1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-touch-icon" href="icon-192.png">
<!-- ===== PWA ===== -->

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    background:#f4f6f9;
    margin:0;
    padding:20px;
    text-align:center;
}

.dashboard{
    max-width:600px;
    margin:auto;
    background:white;
    padding:25px;
    border-radius:15px;
    box-shadow:0 5px 20px rgba(0,0,0,.08);
}

h2,h3{
    margin:5px 0;
}

#officeName{
    font-weight:bold;
    color:#0056b3;
    font-size:20px;
}
#systemName{
    font-weight:normal;
    color:#555;
    margin-bottom:15px;
}
#user{
    color:#555;
    margin-bottom:10px;
}

#clock{
    font-size:28px;
    font-weight:bold;
    color:#333;
    margin:10px 0 20px 0;
}

button{
    padding:14px 22px;
    font-size:16px;
    margin:8px;
    cursor:pointer;
    border:none;
    border-radius:8px;
    transition:.2s;
}

button:hover{ opacity:.85; }

#inBtn{ background:#28a745; color:white; display:none; }
#outBtn{ background:#dc3545; color:white; display:none; }
.logout-btn{ background:#6c757d; color:white; margin-top:15px; }

#status{ margin-top:15px; font-weight:bold; min-height:25px; }
#historyArea{
    margin-top:20px;
    background:#fafafa;
    padding:15px;
    border-radius:10px;
    text-align:left;
}
.history-item{ border-bottom:1px solid #eee; padding:6px 0; }

.alert-box{
    display:none;
    background:#dc3545;
    border-radius:12px;
    padding:20px;
    margin:15px auto;
    max-width:400px;
    color:white;
    font-size:16px;
    font-weight:bold;
    line-height:1.6;
}
</style>
</head>

<body>

<div class="dashboard">
    <div id="officeName">Upazila ICT Office, Madarganj, Jamalpur</div>
    <div id="systemName">Office Attendance System</div>
    <p id="user"></p>
    <div id="clock">00:00:00</div>

    <div id="loadingMsg">‚è≥ Checking device...</div>

    <button id="inBtn" onclick="markIn()">‚úÖ I am in Office</button>
    <button id="outBtn" onclick="markOut()">üö™ I am Leaving</button>

    <div id="fraudMsg" class="alert-box"></div>
    <div id="deviceMsg" class="alert-box"></div>

    <div id="status"></div>

    <div id="historyArea">
        <h4>üìÖ Last 7 Days History</h4>
        <div id="historyList"></div>
    </div>

    <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<script>
// ================= CONFIG =================
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz8aGa9gSSEDx4zTtbb8fhx9iW-wmx9bE7yf5FUBygZ69lG-1EgSgLJ-LBnomV_wNTY/exec";
const OFFICE_LAT = 24.8946369;
const OFFICE_LNG = 89.7183403;
const MAX_DISTANCE_METERS = 100;

const id   = localStorage.getItem("userid");
const name = localStorage.getItem("name");
if(!id){ location.href="index.html"; }
document.getElementById("user").innerText = `ID: ${id} | Name: ${name}`;

// Elements
const inBtn     = document.getElementById("inBtn");
const outBtn    = document.getElementById("outBtn");
const statusTx  = document.getElementById("status");
const deviceMsg = document.getElementById("deviceMsg");
const fraudMsg  = document.getElementById("fraudMsg");
const loadingMsg= document.getElementById("loadingMsg");

// ================= CLOCK =================
function updateClock(){ document.getElementById("clock").innerText = new Date().toLocaleTimeString(); }
setInterval(updateClock,1000); updateClock();

// ================= DEVICE FINGERPRINT =================
function getDeviceFingerprint(){
    const nav = window.navigator, scr = window.screen;
    const raw = [nav.userAgent, nav.language, scr.width, scr.height, scr.colorDepth, new Date().getTimezoneOffset(), nav.platform||""].join("|");
    let hash=0; for(let i=0;i<raw.length;i++){ const c = raw.charCodeAt(i); hash=((hash<<5)-hash)+c; hash=hash&hash; }
    return Math.abs(hash).toString(16);
}

// ================= CHECK DEVICE =================
let deviceAllowed=false;
function checkDeviceAndLoad(){
    const fp = getDeviceFingerprint();
    fetch(`${WEB_APP_URL}?action=checkdevice&id=${id}&fp=${fp}`)
    .then(r=>r.json())
    .then(res=>{
        loadingMsg.style.display="none";
        if(res.status==="blocked"){
            deviceMsg.style.display="block";
            inBtn.style.display=outBtn.style.display="none";
            loadHistory(false);
        } else {
            deviceMsg.style.display="none";
            loadHistory(true);
        }
    })
    .catch(err=>{
        console.log("Device check failed:",err);
        loadingMsg.style.display="none";
        loadHistory(false);
    });
}

// ================= HISTORY =================
function loadHistory(allowed){
    if(allowed!==undefined) deviceAllowed=allowed;
    fetch(`${WEB_APP_URL}?action=history&id=${id}`)
    .then(r=>r.json())
    .then(rows=>displayHistory(rows))
    .catch(err=>{ console.log(err); statusTx.innerText="‚ùå Load Failed"; });
}

function displayHistory(rows){
    const list = document.getElementById("historyList"); list.innerHTML="";
    const today = new Date();
    for(let i=0;i<7;i++){
        let d=new Date(); d.setDate(today.getDate()-i);
        let dayStr = `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
        let rec = rows.find(r => String(r.id).trim()===id && String(r.date).trim()===dayStr);
        let html = rec?`‚úÖ In: ${rec.inTime||'---'} | Out: ${rec.outTime||'---'} | Status: ${rec.status||'---'}`:"‚ùå No Record";
        const div=document.createElement("div"); div.className="history-item"; div.innerHTML=`<strong>${i===0?"Today":dayStr}:</strong> ${html}`;
        list.appendChild(div);
    }
    controlButtons(rows);
}

// ================= DISTANCE =================
function getDistance(lat1,lng1,lat2,lng2){
    const R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLng=(lng2-lng1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ================= MARK =================
function getLocationAndMark(type,status){
    statusTx.innerText="üìç Checking location...";
    fraudMsg.style.display="none";
    navigator.geolocation.getCurrentPosition(pos=>{
        const dist=getDistance(pos.coords.latitude,pos.coords.longitude,OFFICE_LAT,OFFICE_LNG);
        if(dist<=MAX_DISTANCE_METERS){ sendData(status,type,pos.coords.latitude,pos.coords.longitude); }
        else {
            fraudMsg.style.display="block";
            fraudMsg.innerHTML=`üö® Warning! üö®<br>You're ${Math.round(dist)} meters outside office.`;
        }
    }, err=>{ statusTx.innerText="‚ùå Location blocked!"; }, {enableHighAccuracy:true,timeout:10000});
}

function sendData(status,type,lat,lng){
    const fd = new FormData();
    fd.append("id",id); fd.append("name",name); fd.append("status",status);
    fd.append("type",type); fd.append("lat",lat||""); fd.append("lng",lng||"");
    fetch(WEB_APP_URL,{method:"POST",body:fd})
    .then(r=>r.json())
    .then(d=>{ if(d.success){ loadHistory(); statusTx.innerText=`‚úÖ Marked ${type.toUpperCase()} successfully`; } })
    .catch(()=>{ statusTx.innerText="‚ùå Submit Failed"; });
}

function markIn(){ let mins=(new Date()).getHours()*60+(new Date()).getMinutes(); let status = mins>=(10*60)?"Late Entry":"Present"; getLocationAndMark("in",status);}
function markOut(){ let mins=(new Date()).getHours()*60+(new Date()).getMinutes(); let status = mins<(16*60+45)?"Early Leave":"Present"; getLocationAndMark("out",status);}

// ================= BUTTON CONTROL =================
function controlButtons(rows){
    const now=new Date(), mins=now.getHours()*60+now.getMinutes();
    inBtn.style.display=outBtn.style.display="none";
    if(!deviceAllowed) return;

    const todayStr=`${now.getMonth()+1}/${now.getDate()}/${now.getFullYear()}`;
    const rec=rows.find(r=>String(r.id).trim()===id && String(r.date).trim()===todayStr);

    const IN_START=8*60+15, IN_CLOSE=10*60+30, OUT_START=15*60+30, OUT_CLOSE=20*60;

    if(!rec || !rec.inTime){ if(mins>=IN_START && mins<=IN_CLOSE) inBtn.style.display="inline-block"; }
    if(rec && rec.inTime && !rec.outTime){ if(mins>=OUT_START && mins<=OUT_CLOSE) outBtn.style.display="inline-block"; }
    if(rec && rec.inTime && rec.outTime) statusTx.innerText="‚úÖ Attendance complete for today";
}

// ================= LOGOUT =================
function logout(){ localStorage.clear(); location.href="index.html"; }

// ================= START =================
checkDeviceAndLoad();
</script>

</body>
</html>
