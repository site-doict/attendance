<!DOCTYPE html>
<html>
<head>
<title>Attendance Dashboard</title>
<style>
    body{ font-family:Arial; background:#f9f9f9; padding:30px; text-align: center; }
    h2{ color:#0056b3; }
    #clock { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 20px; background: #eee; display: inline-block; padding: 10px 20px; border-radius: 10px; }
    button{ padding:12px 25px; font-size:16px; margin:10px 0; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer; }
    #status{ margin-top:20px; font-weight:bold; color: #d9534f; padding: 15px; border-radius: 8px; display: inline-block; min-width: 250px; }
    .danger-box { background: #ffebee; color: #c62828; border: 2px solid #ef5350; animation: shake 0.5s; }
    @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
    #historyArea { margin-top: 30px; max-width: 400px; margin-left: auto; margin-right: auto; text-align: left; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .history-item { border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; font-size: 14px; }
    .history-date { font-weight: bold; color: #555; }
    .logout-btn { background: #6c757d; margin-top: 50px; color:white; padding:10px; border:none; border-radius:5px; cursor:pointer;}
</style>
</head>
<body>

<h2>Welcome</h2>
<p id="user"></p>
<div id="clock">00:00:00</div>

<h3>Attendance</h3>
<button id="inBtn" onclick="markIn()" style="display:none;">‚úÖ I am in Office</button>
<button id="outBtn" onclick="markOut()" style="display:none;">üö™ I am Leaving</button>

<p id="status"></p>

<div id="historyArea">
    <h4 style="margin-top:0; color:#0056b3;">üìÖ Last 7 Days History</h4>
    <div id="historyList"></div>
</div>

<button class="logout-btn" onclick="logout()">Logout</button>

<script>
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf6vzUcheslghKL4nR-a7_GgN3VESLjazzfsaxnmTuEaIY0ow/formResponse";
const OFFICE_LAT = 24.8947079, OFFICE_LONG = 89.7182064, MAX_DISTANCE = 1500;

const id = localStorage.getItem("userid");
const name = localStorage.getItem("name");
if(!id){ window.location.href="index.html"; }
document.getElementById("user").innerText = "ID: " + id + " | Name: " + name;

const inBtn = document.getElementById("inBtn"), outBtn = document.getElementById("outBtn"), statusTxt = document.getElementById("status");

function updateClock() {
    const now = new Date(), hour = now.getHours(), today = now.toLocaleDateString();
    document.getElementById("clock").innerText = now.toLocaleTimeString();
    if (statusTxt.classList.contains("danger-box")) return;

    const hasIn = localStorage.getItem("lastInDate_" + id) === today;
    const hasOut = localStorage.getItem("lastOutDate_" + id) === today;

    if (hour < 11) {
        inBtn.style.display = hasIn ? "none" : "inline-block";
        outBtn.style.display = "none";
        statusTxt.innerText = hasIn ? "‚úÖ Already Marked IN" : "";
    } else if (hour >= 14 && hour < 23) { // Allowed until 11 PM for testing
        inBtn.style.display = "none";
        outBtn.style.display = hasOut ? "none" : "inline-block";
        statusTxt.innerText = hasOut ? "‚úÖ Already Marked OUT" : "";
    } else {
        inBtn.style.display = "none"; outBtn.style.display = "none";
        statusTxt.innerText = "Attendance Closed";
    }
}
setInterval(updateClock, 1000);
updateClock();

function loadHistory() {
    const list = document.getElementById("historyList");
    list.innerHTML = "";
    for (let i = 0; i < 7; i++) {
        let d = new Date(); 
        d.setDate(d.getDate() - i);
        let dateKey = d.toLocaleDateString();

        const hasIn = localStorage.getItem("lastInDate_" + id) === dateKey;
        const hasOut = localStorage.getItem("lastOutDate_" + id) === dateKey;
        const inStatus = localStorage.getItem("lastInStatus_" + id) || "---";
        const outStatus = localStorage.getItem("lastOutStatus_" + id) || "---";

        let statusHtml = "<span style='color:red;'>‚ùå No Record</span>";

        if (hasIn || hasOut) {
            statusHtml = `<span style='color:green;'>In: ${hasIn ? inStatus : '‚ùå'} | Out: ${hasOut ? outStatus : '‚ùå'}</span>`;
        }

        const item = document.createElement("div");
        item.className = "history-item";
        item.innerHTML = `<span class="history-date">${i === 0 ? "Today" : dateKey}</span>
                          <span class="history-status">${statusHtml}</span>`;
        list.appendChild(item);
    }
}


    
loadHistory();

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function markIn(){
    const t = {hour: new Date().getHours(), minute: new Date().getMinutes()};
    let status = "Present";
    if (t.hour === 10 && t.minute <= 30) status = "Late";
    else if (t.hour >= 10 && t.minute > 30) status = "Absent";
    sendData(status, true);
}

function markOut(){
    const t = {hour: new Date().getHours(), minute: new Date().getMinutes()};
    let status = (t.hour < 16 || (t.hour === 16 && t.minute < 20)) ? "Early Leave" : "Present";
    sendData(status, false);
}

function sendData(status, isIn) {
    statusTxt.innerText = "üìç Verifying location...";
    statusTxt.className = ""; 

    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const long = pos.coords.longitude;
        const dist = getDistance(lat, long, OFFICE_LAT, OFFICE_LONG);

        if (dist > MAX_DISTANCE) {
            statusTxt.className = "danger-box";
            statusTxt.innerHTML = `üö´ ILLEGAL ATTEMPT!<br>You are ${Math.round(dist)}m away.`;
            return;
        }

        const now = new Date();
        const dateStr = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()}`;
        const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2, "0")}`;

        const fd = new FormData();
        // Use your verified entry IDs
        fd.append("entry.1859002656", id);                  // ID
        fd.append("entry.339531515", name);                // Name
        fd.append("entry.1163502489", dateStr);             // Date
        fd.append("entry.542167419", isIn ? timeStr : "---"); // InTime
        fd.append("entry.1532127027", isIn ? "---" : timeStr); // OutTime
        fd.append("entry.1008700991", lat);                 // Lat
        fd.append("entry.698099376", long);                 // Long
        fd.append("entry.1126631987", status);               // Status

        fetch(FORM_URL, { method: "POST", mode: "no-cors", body: fd })
        .then(() => {
            const today = now.toLocaleDateString();
            if (isIn) {
                localStorage.setItem("lastInDate_" + id, today);
                localStorage.setItem("lastInStatus_" + id, status);
            } else {
                localStorage.setItem("lastOutDate_" + id, today);
                localStorage.setItem("lastOutStatus_" + id, status);
            }
            statusTxt.className = "";
            statusTxt.style.color = "green";
            statusTxt.innerHTML = "‚úÖ Submitted Successfully!";
            loadHistory(); 
            updateClock();
        })
        .catch(() => alert("Network Error. Try again."));
    }, () => {
        statusTxt.innerText = "‚ùå GPS Error. Please enable Location.";
    });
}


function logout(){
    localStorage.removeItem("userid"); localStorage.removeItem("name");
    window.location.href = "index.html";
}
</script>
</body>
</html>

