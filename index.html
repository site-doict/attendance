<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Office Attendance</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a1a1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Office Attendance">
<link rel="apple-touch-icon" href="icon-192.png">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
*{ box-sizing: border-box; margin:0; padding:0; }

body{
    font-family: Arial, sans-serif;
    background: #1a1a1a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

.login-box{
    background: white;
    padding: 35px 30px;
    width: 320px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,.4);
}

.login-box h2{
    text-align: center;
    margin-bottom: 8px;
    color: #1a1a1a;
    font-size: 22px;
}

.login-box p{
    text-align: center;
    color: #888;
    font-size: 13px;
    margin-bottom: 25px;
}

input{
    width: 100%;
    padding: 12px 15px;
    margin: 8px 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 15px;
    outline: none;
}

input:focus{
    border-color: #0056b3;
}

button{
    width: 100%;
    padding: 12px;
    background: #0056b3;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 8px;
    font-size: 16px;
    margin-top: 10px;
    font-weight: bold;
}

button:hover{ background: #004099; }

#error{
    color: #dc3545;
    text-align: center;
    margin-top: 12px;
    font-size: 14px;
    min-height: 20px;
}

#loading{
    display: none;
    text-align: center;
    color: #888;
    margin-top: 10px;
    font-size: 14px;
}
</style>
</head>

<body>

<div class="login-box">
    <h2>üè¢ Office Attendance</h2>
    <p>Upazila ICT Office, Madarganj</p>

    <input type="text" id="userid" placeholder="Enter Employee ID" autocomplete="off">
    <input type="password" id="password" placeholder="Enter Password">

    <button onclick="login()">Login</button>

    <div id="loading">‚è≥ Verifying...</div>
    <div id="error"></div>
</div>

<script>

const USER_SHEET =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQU4-KlIY732XZyhLAZB4-5pUrAcwiqO1bkhrVladSas6MT7ZK967vkNDPd_QzAu7rM72JnT5F5jDzL/pub?gid=32388154&single=true&output=csv";

// Register Service Worker
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js')
    .then(() => console.log("SW registered"))
    .catch(err => console.log("SW error:", err));
}

// If already logged in, redirect
const existingId = localStorage.getItem("userid");
const existingRole = localStorage.getItem("role");
if(existingId){
    if(existingRole === "admin" || existingRole === "superadmin"){
        location.href = "admin.html";
    } else {
        location.href = "dashboard.html";
    }
}

function login(){

    const id   = document.getElementById("userid").value.trim();
    const pass = document.getElementById("password").value.trim();
    const errEl  = document.getElementById("error");
    const loadEl = document.getElementById("loading");

    errEl.innerText = "";

    if(!id || !pass){
        errEl.innerText = "‚ùå Enter ID and Password";
        return;
    }

    loadEl.style.display = "block";

    Papa.parse(USER_SHEET, {

        download: true,
        header: true,
        skipEmptyLines: true,

        complete: function(res){

            loadEl.style.display = "none";

            const users = res.data.filter(u => u.ID && u.Password);
            let found = false;

            users.forEach(u => {

                const uID   = (u.ID   || "").trim();
                const uPass = (u.Password || "").trim();
                const uRole = (u.Role || "user").trim().toLowerCase();
                const uName = (u.Name || "").trim();

                if(uID === id && uPass === pass){

                    found = true;

                    localStorage.setItem("userid", uID);
                    localStorage.setItem("name",   uName);
                    localStorage.setItem("role",   uRole);

                    if(uRole === "admin" || uRole === "superadmin"){
                        location.href = "admin.html";
                    } else {
                        location.href = "dashboard.html";
                    }
                }
            });

            if(!found){
                errEl.innerText = "‚ùå Wrong ID or Password";
            }
        },

        error: function(err){
            loadEl.style.display = "none";
            console.error(err);
            errEl.innerText = "‚ùå Cannot connect. Try again.";
        }
    });
}

// Allow Enter key to login
document.addEventListener("keydown", function(e){
    if(e.key === "Enter") login();
});

</script>

</body>
</html>
